<extend name="Public:base" />
<block name="title">节点管理</block>
<block name="content">
    <style>
        .badge-type { display:inline-block; padding:2px 10px; border-radius:4px; color:#fff; font-size:12px; }
        .badge-online { background:#10b981; }
        .badge-offline { background:#ef4444; }
        .badge-abnormal { background:#f59e0b; }
        .checking { opacity:0.6; pointer-events:none; }
    </style>

    <nav class="breadcrumb">
        <a href="{:U('Admin/Index/index')}">首页</a>
        <span class="separator">/</span>
        <a href="{:U('Admin/Index/index')}">后台管理</a>
        <span class="separator">/</span>
        <span class="current">节点管理</span>
    </nav>

    <div class="page-content">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between" style="display:flex;align-items:center;justify-content:space-between;">
                    <ul class="nav nav-tabs">
                        <li class="nav-item"><a class="nav-link active" href="{:U('Admin/NodeMgr/index')}">节点列表</a></li>
                        <li class="nav-item"><a class="nav-link" href="{:U('Admin/NodeMgr/add')}">添加节点</a></li>
                        <li class="nav-item"><a class="nav-link" href="{:U('Admin/NodeMgr/collect')}">采集节点</a></li>
                        <li class="nav-item"><a class="nav-link" href="{:U('Admin/NodeMgr/assignNode')}">节点分配</a></li>
                    </ul>
                    <button class="btn btn-primary" id="btnCheckAll" onclick="healthCheckAll()">批量检测</button>
                </div>
            </div>
            <div class="card-body">
                <!-- 桌面端表格 -->
                <div class="desktop-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="4%">ID</th>
                                <th>名称</th>
                                <th class="hide-mobile">服务器</th>
                                <th width="5%">端口</th>
                                <th width="6%">协议</th>
                                <th width="7%">延迟</th>
                                <th width="7%">状态</th>
                                <th width="6%" class="hide-mobile">在线率</th>
                                <th width="5%">可见</th>
                                <th width="12%" class="hide-mobile">最后检测</th>
                                <th width="18%">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <foreach name="list" item="v">
                            <tr id="node-row-{$v['id']}">
                                <td>{$v['id']}</td>
                                <td>{$v['name']}</td>
                                <td class="hide-mobile">{$v['server']}</td>
                                <td>{$v['port']}</td>
                                <td>{$v['type']}</td>
                                <td class="node-latency">{$v['latency_html']}</td>
                                <td class="node-status">{$v['status_text']}</td>
                                <td class="hide-mobile">{$v['uptime_percent']}%</td>
                                <td>
                                    <if condition="$v['is_visible'] eq 1"><span style="color:#10b981">是</span><else /><span style="color:#999">否</span></if>
                                </td>
                                <td class="hide-mobile node-lasttest">{$v['last_test_fmt']}</td>
                                <td>
                                    <div class="action-group">
                                        <a class="btn btn-xs btn-warning" href="{:U('Admin/NodeMgr/edit',array('id'=>$v['id']))}">编辑</a>
                                        <a class="btn btn-xs btn-danger" onclick="return confirm('确定删除该节点?');" href="{:U('Admin/NodeMgr/del',array('id'=>$v['id']))}">删除</a>
                                        <button class="btn btn-xs btn-info" onclick="healthCheck({$v['id']},this)">检测</button>
                                        <if condition="$v['is_visible'] eq 1">
                                            <button class="btn btn-xs btn-default" onclick="toggleVisible({$v['id']},0,this)">隐藏</button>
                                        <else />
                                            <button class="btn btn-xs btn-success" onclick="toggleVisible({$v['id']},1,this)">显示</button>
                                        </if>
                                    </div>
                                </td>
                            </tr>
                            </foreach>
                        </tbody>
                    </table>
                </div>
                <!-- 移动端卡片 -->
                <div class="mobile-card-list">
                    <foreach name="list" item="v">
                    <div class="mobile-card" id="mobile-node-{$v['id']}">
                        <div class="card-header-row">
                            <div class="card-title">{$v['name']}</div>
                            <span class="node-status">{$v['status_text']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">服务器</span>
                            <span class="value">{$v['server']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">端口</span>
                            <span class="value">{$v['port']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">协议</span>
                            <span class="value">{$v['type']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">延迟</span>
                            <span class="value node-latency">{$v['latency_html']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">状态</span>
                            <span class="value node-status">{$v['status_text']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">在线率</span>
                            <span class="value">{$v['uptime_percent']}%</span>
                        </div>
                        <div class="card-actions">
                            <a class="btn btn-xs btn-warning" href="{:U('Admin/NodeMgr/edit',array('id'=>$v['id']))}">编辑</a>
                            <a class="btn btn-xs btn-danger" onclick="return confirm('确定删除该节点?');" href="{:U('Admin/NodeMgr/del',array('id'=>$v['id']))}">删除</a>
                            <button class="btn btn-xs btn-info" onclick="healthCheck({$v['id']},this)">检测</button>
                        </div>
                    </div>
                    </foreach>
                </div>
                <!-- 分页 -->
                <if condition="$page">
                <div class="page-footer">
                    <div class="pagination-info">共 {$total} 条记录</div>
                    <div class="pagination-container">
                        <div class="pagination">{$page}</div>
                    </div>
                </div>
                </if>
            </div>
        </div>
    </div>

    <script src="__PUBLIC__/statics/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
    function healthCheck(id, btn) {
        var row = document.getElementById('node-row-' + id);
        if (btn) btn.disabled = true;
        if (btn) btn.textContent = '检测中...';
        $.ajax({
            url: "{:U('Admin/NodeMgr/healthCheck')}",
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function(res) {
                if (res.code == 0) {
                    var d = res.data;
                    row.querySelector('.node-latency').innerHTML = d.latency_html;
                    row.querySelector('.node-status').innerHTML = d.status_text;
                    var lt = row.querySelector('.node-lasttest');
                    if (lt) lt.textContent = d.last_test;
                    // 同步更新移动端卡片
                    var mc = document.getElementById('mobile-node-' + id);
                    if (mc) {
                        mc.querySelector('.node-latency').innerHTML = d.latency_html;
                        var ms = mc.querySelectorAll('.node-status');
                        for (var i = 0; i < ms.length; i++) ms[i].innerHTML = d.status_text;
                    }
                } else {
                    alert(res.msg);
                }
            },
            error: function() { alert('请求失败'); },
            complete: function() {
                if (btn) { btn.disabled = false; btn.textContent = '检测'; }
            }
        });
    }
    function healthCheckAll() {
        var btn = document.getElementById('btnCheckAll');
        btn.disabled = true;
        btn.textContent = '检测中...';
        $.ajax({
            url: "{:U('Admin/NodeMgr/healthCheckAll')}",
            type: 'post',
            dataType: 'json',
            success: function(res) {
                if (res.code == 0 && res.data) {
                    for (var i = 0; i < res.data.length; i++) {
                        var d = res.data[i];
                        var row = document.getElementById('node-row-' + d.id);
                        if (row) {
                            row.querySelector('.node-latency').innerHTML = d.latency_html;
                            row.querySelector('.node-status').innerHTML = d.status_text;
                            var lt = row.querySelector('.node-lasttest');
                            if (lt) lt.textContent = d.last_test;
                        }
                        var mc = document.getElementById('mobile-node-' + d.id);
                        if (mc) {
                            mc.querySelector('.node-latency').innerHTML = d.latency_html;
                            var ms = mc.querySelectorAll('.node-status');
                            for (var j = 0; j < ms.length; j++) ms[j].innerHTML = d.status_text;
                        }
                    }
                    alert('批量检测完成');
                } else {
                    alert(res.msg || '检测失败');
                }
            },
            error: function() { alert('请求失败'); },
            complete: function() { btn.disabled = false; btn.textContent = '批量检测'; }
        });
    }
    function toggleVisible(id, visible, btn) {
        if (btn) btn.disabled = true;
        $.ajax({
            url: "{:U('Admin/NodeMgr/toggleVisible')}",
            type: 'post',
            data: {id: id, is_visible: visible},
            dataType: 'json',
            success: function(res) {
                if (res.code == 0) {
                    location.reload();
                } else {
                    alert(res.msg || '操作失败');
                }
            },
            error: function() { alert('请求失败'); },
            complete: function() { if (btn) btn.disabled = false; }
        });
    }
    </script>
</block>

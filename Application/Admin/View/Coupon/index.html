<extend name="Public:base" />
<block name="title">优惠券管理</block>
<block name="content">
    <style>
        .badge-type { display:inline-block; padding:2px 10px; border-radius:4px; color:#fff; font-size:12px; }
        .badge-percent { background:#3b82f6; }
        .badge-fixed { background:#f59e0b; }
    </style>

    <nav class="breadcrumb">
        <a href="{:U('Admin/Index/index')}">首页</a>
        <span class="separator">/</span>
        <a href="{:U('Admin/Index/index')}">后台管理</a>
        <span class="separator">/</span>
        <span class="current">优惠券管理</span>
    </nav>

    <div class="page-content">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="{:U('Admin/Coupon/index')}">优惠券列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{:U('Admin/Coupon/add')}">添加优惠券</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">

                <!-- 桌面端表格 -->
                <div class="desktop-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>优惠码</th>
                                <th>名称</th>
                                <th>类型</th>
                                <th>折扣值</th>
                                <th>最低消费</th>
                                <th>有效期</th>
                                <th>已用/总量</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <foreach name="list" item="v">
                            <tr>
                                <td>{$v['id']}</td>
                                <td><code>{$v['code']}</code></td>
                                <td>{$v['name']}</td>
                                <td>
                                    <if condition="$v['type'] eq 1"><span class="badge-type badge-percent">百分比</span></if>
                                    <if condition="$v['type'] eq 2"><span class="badge-type badge-fixed">固定额</span></if>
                                </td>
                                <td>{$v['discount_fmt']}</td>
                                <td>&yen;{$v['min_amount']}</td>
                                <td>{$v['valid_from_fmt']}<br/>~ {$v['valid_until_fmt']}</td>
                                <td>{$v['quantity_fmt']}</td>
                                <td>{$v['status_text']}</td>
                                <td>
                                    <a class="btn btn-xs btn-warning" href="{:U('Admin/Coupon/edit',array('id'=>$v['id']))}">编辑</a>
                                    <button class="btn btn-xs btn-danger ajax-del" data-url="{:U('Admin/Coupon/del',array('id'=>$v['id']))}">删除</button>
                                    <button class="btn btn-xs toggle-btn {$v['is_active']?'btn-success':'btn-default'}" data-id="{$v['id']}">{$v['is_active']?'已启用':'已禁用'}</button>
                                </td>
                            </tr>
                            </foreach>
                        </tbody>
                    </table>
                </div>
                <!-- 移动端卡片 -->
                <div class="mobile-card-list">
                    <foreach name="list" item="v">
                    <div class="mobile-card">
                        <div class="card-header-row">
                            <div class="card-title"><code>{$v['code']}</code> {$v['name']}</div>
                        </div>
                        <div class="card-row">
                            <span class="label">类型</span>
                            <span class="value">
                                <if condition="$v['type'] eq 1"><span class="badge-type badge-percent">百分比</span></if>
                                <if condition="$v['type'] eq 2"><span class="badge-type badge-fixed">固定额</span></if>
                            </span>
                        </div>
                        <div class="card-row">
                            <span class="label">折扣值</span>
                            <span class="value">{$v['discount_fmt']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">最低消费</span>
                            <span class="value">&yen;{$v['min_amount']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">有效期</span>
                            <span class="value">{$v['valid_from_fmt']} ~ {$v['valid_until_fmt']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">已用/总量</span>
                            <span class="value">{$v['quantity_fmt']}</span>
                        </div>
                        <div class="card-row">
                            <span class="label">状态</span>
                            <span class="value">{$v['status_text']}</span>
                        </div>
                        <div class="card-actions">
                            <a class="btn btn-xs btn-warning" href="{:U('Admin/Coupon/edit',array('id'=>$v['id']))}">编辑</a>
                            <a class="btn btn-xs btn-danger" onClick="return confirm('确定删除该优惠券?');" href="{:U('Admin/Coupon/del',array('id'=>$v['id']))}">删除</a>
                            <button class="btn btn-xs toggle-btn {$v['is_active']?'btn-success':'btn-default'}" data-id="{$v['id']}">{$v['is_active']?'已启用':'已禁用'}</button>
                        </div>
                    </div>
                    </foreach>
                </div>
                <!-- 分页 -->
                <div class="page-footer">
                    <div class="pagination-container">{$page}</div>
                </div>

            </div>
        </div>
    </div>

    <script>
    $(function(){
        $('.ajax-del').click(function(){
            if(!confirm('确定删除该优惠券?')) return;
            var btn = $(this);
            $.ajax({
                url: btn.data('url'),
                dataType: 'json',
                success: function(res){
                    if(res.code == 0){ location.reload(); }
                    else { alert(res.msg); }
                }
            });
        });
        $('.toggle-btn').click(function(){
            var btn = $(this);
            var id = btn.data('id');
            $.ajax({
                url: "{:U('Admin/Coupon/toggle')}",
                type: 'post',
                data: {id: id},
                dataType: 'json',
                success: function(res){
                    if(res.code == 0){
                        alert(res.msg);
                        location.reload();
                    } else {
                        alert(res.msg);
                    }
                }
            });
        });
    });
    </script>
</block>

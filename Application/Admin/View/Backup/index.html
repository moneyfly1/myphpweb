<extend name="Public:base" />
<block name="title">数据备份</block>
<block name="content">
    <style>
        .backup-actions { margin-bottom: 1.5rem; }
        .btn-backup { padding: 10px 24px; font-size: 14px; cursor: pointer; }
        .btn-backup:disabled { opacity: 0.6; cursor: not-allowed; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        @media (max-width:768px) {
            .table { font-size: 14px!important; }
            .table th,.table td { padding: 8px 6px!important; }
            .btn { font-size: 14px!important; padding: 8px 12px!important; }
        }
    </style>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{:U('Admin/Index/index')}">首页</a></li>
            <li class="breadcrumb-item active">数据备份</li>
        </ol>
    </nav>
    <div class="page-navigation">
        <a href="{:U('Admin/Index/index')}" class="nav-item">首页</a>
        <div class="nav-separator">/</div>
        <div class="nav-item active">数据备份</div>
    </div>
    <div class="page-content">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-start">
                    <ul class="nav nav-tabs border-0">
                        <li class="nav-item">
                            <a class="nav-link active" href="{:U('Admin/Backup/index')}">备份列表</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="backup-actions">
                    <button class="btn btn-primary btn-backup" id="btnCreate">创建备份</button>
                </div>
                <if condition="$backups">
                <table class="table table-striped table-bordered table-hover">
                    <tr>
                        <th width="35%">文件名</th>
                        <th width="15%">大小</th>
                        <th width="25%">创建时间</th>
                        <th width="25%">操作</th>
                    </tr>
                    <foreach name="backups" item="v">
                    <tr>
                        <td>{$v['name']}</td>
                        <td>{$v['size']}</td>
                        <td>{$v['time']}</td>
                        <td>
                            <a class="btn btn-xs btn-success" href="{:U('Admin/Backup/download',array('name'=>$v['name']))}">下载</a>
                            <button class="btn btn-xs btn-danger ajax-del" data-url="{:U('Admin/Backup/del',array('name'=>$v['name']))}">删除</button>
                        </td>
                    </tr>
                    </foreach>
                </table>
                <else />
                <div class="empty-state">暂无备份文件，点击上方按钮创建备份</div>
                </if>
            </div>
        </div>
    </div>
    <script src="__PUBLIC__/statics/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
    $(function(){
        $('.ajax-del').click(function(){
            if(!confirm('确定删除该备份文件?')) return;
            var btn = $(this);
            $.ajax({
                url: btn.data('url'),
                dataType: 'json',
                success: function(res){
                    if(res.code == 0){ location.reload(); }
                    else { alert(res.msg); }
                }
            });
        });
        $('#btnCreate').click(function(){
            var btn = $(this);
            btn.prop('disabled', true).html('<span class="spinner"></span>备份中...');
            $.ajax({
                url: "{:U('Admin/Backup/create')}",
                type: 'post',
                dataType: 'json',
                success: function(res){
                    if(res.code == 0){
                        alert(res.msg + ' - ' + res.data.name + ' (' + res.data.size + ')');
                        location.reload();
                    } else {
                        alert(res.msg);
                        btn.prop('disabled', false).text('创建备份');
                    }
                },
                error: function(){
                    alert('请求失败，请重试');
                    btn.prop('disabled', false).text('创建备份');
                }
            });
        });
    });
    </script>
</block>

<extend name="Public:base" />
<block name="title">用户列表</block>
<block name="content">
    <style>

        /* 手机端卡片式布局 */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.2rem;
                padding: 10px 0;
            }
            .tabbable {
                padding: 0 5px;
            }
            
            /* 隐藏桌面端表格 */
            .table-responsive {
                display: none;
            }
            
            /* 显示手机端卡片列表 */
            .mobile-card-list {
                display: block;
            }
            
            /* 搜索表单优化 */
            .search-form {
                margin-bottom: 20px;
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .search-form input[type="text"] {
                flex: 1;
                font-size: 16px;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid #ddd;
                margin: 0;
            }
            .search-form .btn {
                width: auto !important;
                font-size: 16px;
                padding: 12px 20px;
                margin: 0;
                border-radius: 8px;
            }
            
            /* 操作按钮组优化 */
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }
            .action-buttons .btn {
                width: 100% !important;
                font-size: 16px;
                padding: 15px;
                margin: 0;
                border-radius: 8px;
            }
            
            /* 批量操作按钮优化 */
            .batch-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin: 20px 0;
            }
            .batch-actions .btn {
                font-size: 14px;
                padding: 12px 8px;
                margin: 0;
                border-radius: 8px;
            }
            
            .breadcrumb {
                display: none !important;
            }
            
            .page-navigation {
                font-size: 12px;
                padding: 8px 12px;
                margin-bottom: 15px;
            }
        }
        
        /* 桌面端隐藏手机卡片 */
        @media (min-width: 769px) {
            .mobile-card-list {
                display: none;
            }
        }
        
        /* 手机端卡片样式 */
        .mobile-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .mobile-card-username {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .mobile-card-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .mobile-card-status.enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .mobile-card-status.disabled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .mobile-card-content {
            margin-bottom: 20px;
        }
        
        .mobile-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 16px;
            padding: 8px 0;
        }
        
        .mobile-card-label {
            color: #666;
            font-weight: 500;
            flex: 1;
        }
        
        .mobile-card-value {
            color: #333;
            text-align: right;
            flex: 1;
        }
        
        .mobile-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 20px;
        }
        
        .mobile-card-actions .btn {
            font-size: 14px;
            padding: 12px 8px;
            margin: 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .mobile-card-actions .btn i {
            font-size: 12px;
        }
        
        /* 复选框优化 */
        .mobile-card-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            transform: scale(1.3);
            z-index: 10;
        }
        
        /* 导航标签样式 */
        .nav-tabs {
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .nav-tabs li a {
            padding: 8px 16px;
            font-size: 16px;
            color: #666;
            background: #f8f9fa;
            border: none;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .nav-tabs li.active a {
            background: #42a5f5;
            color: #fff;
            border-bottom-color: #1976d2;
        }
        
        .nav-tabs li a:hover {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        /* 手机端额外优化 */
        @media (max-width: 768px) {
            /* 手机端导航标签样式优化 */
            .nav-tabs {
                display: flex;
                background: #fff;
                border-bottom: 2px solid #e9ecef;
                margin-bottom: 20px;
                border-radius: 8px 8px 0 0;
                overflow: hidden;
            }
            
            .nav-tabs li {
                flex: 1;
                margin: 0;
            }
            
            .nav-tabs li a {
                display: block;
                padding: 15px 10px;
                text-align: center;
                font-size: 16px;
                font-weight: 500;
                color: #666;
                background: #f8f9fa;
                border: none;
                border-radius: 0;
                text-decoration: none;
                transition: all 0.3s ease;
                border-bottom: 3px solid transparent;
            }
            
            .nav-tabs li.active a {
                background: #42a5f5;
                color: #fff;
                border-bottom-color: #1976d2;
            }
            
            .nav-tabs li a:hover {
                background: #e3f2fd;
                color: #1976d2;
            }
            

            

        }
        
        /* 桌面端样式优化 */
        @media (min-width: 769px) {
            /* 搜索框在桌面端更长 */
            .form-control[name="search"] {
                min-width: 400px !important;
                max-width: 500px;
            }
            
            /* 桌面端搜索框样式 */
            .search-form input[name="search"],
            .search-form .form-control[name="search"] {
                border: 3px solid #1677ff !important;
                border-radius: 8px !important;
                padding: 10px 15px !important;
                font-size: 14px !important;
                background: #f8f9fa !important;
                transition: all 0.3s ease !important;
                outline: none !important;
                box-shadow: 0 2px 8px rgba(22, 119, 255, 0.1) !important;
            }
            
            .search-form input[name="search"]:focus,
            .search-form .form-control[name="search"]:focus {
                border-color: #0958d9 !important;
                box-shadow: 0 0 0 4px rgba(22, 119, 255, 0.2), 0 4px 12px rgba(22, 119, 255, 0.15) !important;
                background: #ffffff !important;
                transform: translateY(-1px) !important;
            }
            
            /* 分页容器在桌面端的优化 */
            .pagination-container {
                justify-content: space-between;
                max-width: 800px;
                margin: 20px auto;
            }
        }
        
        /* 手机端响应式优化 */
        @media (max-width: 768px) {
            /* 手机端搜索框样式 */
            .search-form input[name="search"],
            .search-form .form-control[name="search"] {
                border: 2px solid #1677ff !important;
                border-radius: 8px !important;
                padding: 12px 15px !important;
                font-size: 16px !important;
                background: #f8f9fa !important;
                transition: all 0.3s ease !important;
                outline: none !important;
                box-shadow: 0 2px 8px rgba(22, 119, 255, 0.1) !important;
            }
            
            .search-form input[name="search"]:focus,
            .search-form .form-control[name="search"]:focus {
                border-color: #0958d9 !important;
                box-shadow: 0 0 0 3px rgba(22, 119, 255, 0.2), 0 4px 12px rgba(22, 119, 255, 0.15) !important;
                background: #ffffff !important;
                transform: translateY(-1px) !important;
            }
            
            /* 表格单元格优化 */
            td {
                padding: 8px 4px !important;
                font-size: 16px;
            }
            
            /* QQ号码列宽度调整 */
            td[width="10%"] {
                min-width: 80px;
            }
            
            /* 手机端分页容器居中 */
            .pagination-container {
                justify-content: center;
                flex-direction: row;
                gap: 10px;
                flex-wrap: wrap;
                display: flex;
            }
        }
        
        @media (max-width: 480px) {
            td {
                padding: 2px 1px !important;
                font-size: 11px;
            }
        }
        
    </style>
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{:U('Admin/Index/index')}">
                    <i class="fa fa-home"></i>
                    首页
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{:U('Admin/Index/index')}">
                    后台管理
                </a>
            </li>
            <li class="breadcrumb-item active">
                用户列表
            </li>
        </ol>
    </nav>
    
    <!-- 页面导航路径 -->
    <div class="page-navigation">
        <a href="{:U('Admin/Index/index')}" class="nav-item">
            <i class="fa fa-home"></i>
            首页
        </a>
        <div class="nav-separator">/</div>
        <a href="{:U('Admin/Index/index')}" class="nav-item">
            后台管理
        </a>
        <div class="nav-separator">/</div>
        <div class="nav-item active">
            用户列表
        </div>
    </div>
    
    <!-- 成功提示框 -->
    <div id="success-message" class="alert alert-success" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 9999;">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <span id="success-text"></span>
    </div>
    
    <div class="page-content">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-start">
                    <ul class="nav nav-tabs border-0">
                        <li class="nav-item">
                            <a class="nav-link active" href="{:U('Customer/list')}">用户列表</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{:U('Customer/add')}">添加用户</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <!-- 搜索表单 -->
                <div class="row mb-2" style="margin-bottom: 15px !important;">
                    <div class="col-md-8">
                        <form method="post" class="search-form d-flex">
                            <input type="text" class="form-control me-2" name="search" placeholder="输入qq或任意订阅地址查询" value="{$data[0]['search']}">
                            <button class="btn btn-primary btn-sm" type="submit">搜索</button>
                        </form>
                    </div>
                </div>

                <!-- 桌面端表格 -->
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover table-condensed">
                        <tr>
                            <th><input type="checkbox" class="alls"></th>
                            <th width="10%">qq号码</th>
                            <th><a href="{:U('Customer/list',['order'=>'regtime','type'=>$ordertype])}">注册时间</a></th>
                            <th><a href="{:U('Customer/list',['order'=>'lasttime','type'=>$ordertype])}">最后登录时间</a></th>
                            <th>状态</th>
                            <th>激活</th>
                            <th>操作</th>
                        </tr>
                        <foreach name="data" item="v">
                            <tr>
                                <td><input type="checkbox" class="all" name="all" value="{$v['id']}"></td>
                                <td width="10%">{$v['username']}</td>
                                <td>{$v['regtime']}</td>
                                <td>{$v['lasttime']}</td>
                                <td>{$v['status']}</td>
                                <td>{$v['activation']}</td>
                                <td style="min-width: 160px;">
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                        <a class="btn btn-xs btn-warning" href="{:U('Customer/edit',array('id'=>$v['id']))}">修改</a> 
                                        <a class="btn btn-xs btn-danger user-del-btn" data-id="{$v['id']}" href="javascript:void(0);">删除</a>
                                        <a class="btn btn-xs btn-info" href="{:U('Customer/userLogs',array('id'=>$v['id']))}">操作日志</a>
                                    </div>
                                </td>
                            </tr>
                        </foreach>
                    </table>
                </div>
                
                <!-- 手机端用户卡片列表 -->
                <div class="mobile-card-list">
                    <foreach name="data" item="v">
                        <div class="mobile-card">
                            <input type="checkbox" class="mobile-card-checkbox all" name="all" value="{$v['id']}">
                            
                            <div class="mobile-card-header">
                                <div class="mobile-card-username">{$v['username']}</div>
                                <div class="mobile-card-status {$v['status']==1?'enabled':'disabled'}">{$v['status']==1?'启用':'禁用'}</div>
                            </div>
                            
                            <div class="mobile-card-content">
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">注册时间:</span>
                                    <span class="mobile-card-value">{$v['regtime']}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">最后登录:</span>
                                    <span class="mobile-card-value">{$v['lasttime']}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">激活状态:</span>
                                    <span class="mobile-card-value">{$v['activation']}</span>
                                </div>
                            </div>
                            
                            <div class="mobile-card-actions">
                                <a class="btn btn-xs btn-warning" href="{:U('Customer/edit',array('id'=>$v['id']))}">
                                    <i class="fa fa-edit"></i> 修改
                                </a>
                                <a class="btn btn-xs btn-danger user-del-btn" data-id="{$v['id']}" href="javascript:void(0);">
                                    <i class="fa fa-trash"></i> 删除
                                </a>
                                <a class="btn btn-xs btn-info" href="{:U('Customer/userLogs',array('id'=>$v['id']))}">
                                    <i class="fa fa-list-alt"></i> 操作日志
                                </a>
                            </div>
                        </div>
                    </foreach>
                </div>
                
                <!-- 批量操作 -->
                <div style="margin:10px 0;">
                    <span class="inputword">全选</span>
                    <input type="checkbox" class="alls">
                </div>
                <div class="batch-actions-with-pagination">
                    <div class="batch-actions">
                        <div id="allDel" class="btn btn-danger">批量删除</div>
                        <div id="allPush" class="btn btn-success">批量推送</div>
                        <div id="allDisable" class="btn btn-warning">批量禁用</div>
                        <div id="allEnable" class="btn btn-info">批量启用</div>
                    </div>
                    <div class="pagination-wrapper">
                        <div class="pagination" id="pagination-container">{$page}</div>
                        <div class="pagination-jump">
                            <span class="jump-label">跳转到</span>
                            <input type="number" id="jumpPage" min="1" placeholder="页码">
                            <button id="jumpButton" class="btn btn-primary">确定</button>
                        </div>
                    </div>
                </div>
                <div class="pagination-info">
                    <span class="text-muted">共 {$totalCount} 条记录</span>
                </div>
            </div>
        </div>
    </div>
    <script src="__PUBLIC__/statics/js/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(function () {
        // 显示成功提示的函数
        function showSuccessMessage(message) {
            $('#success-text').text(message);
            $('#success-message').fadeIn().delay(3000).fadeOut();
        }
        
        $('.alls').change(function(){
            var checked = $(this).is(':checked');
            $('.all').prop('checked',checked);
        });

        // 批量删除
        $('#allDel').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ','+$(this).val();
            });
            id = id.substr(1);
            if(id==''){
                alert('请选择要删除的选项');
            }else{
                if(confirm('确定要删除选中的用户吗？此操作将删除用户的所有相关数据（订阅、订单、设备日志等）！')){
                    $.post("{:U('Customer/allDel')}",{id:id}, function(res){
                        if(res.status==1){
                            showSuccessMessage(res.info || '批量删除成功！');
                            setTimeout(function(){ location.reload(); }, 1000);
                        }else{
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 批量推送
        $('#allPush').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ','+$(this).val();
            });
            id = id.substr(1);
            if(id==''){
                alert('请选择要推送的选项');
            }else{
                if(confirm('确定要推送选中的用户吗？')){
                    $.post("{:U('Customer/allPush')}",{id:id}, function(res){
                        if(res.status==1){
                            showSuccessMessage(res.info || '批量推送成功！');
                        }else{
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 批量禁用
        $('#allDisable').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ','+$(this).val();
            });
            id = id.substr(1);
            if(id==''){
                alert('请选择要禁用的选项');
            }else{
                if(confirm('确定要禁用选中的用户吗？')){
                    $.post("{:U('Customer/allDisable')}",{id:id}, function(res){
                        if(res.status==1){
                            showSuccessMessage(res.info || '批量禁用成功！');
                            setTimeout(function(){ location.reload(); }, 1000);
                        }else{
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 批量启用
        $('#allEnable').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ','+$(this).val();
            });
            id = id.substr(1);
            if(id==''){
                alert('请选择要启用的选项');
            }else{
                if(confirm('确定要启用选中的用户吗？')){
                    $.post("{:U('Customer/allEnable')}",{id:id}, function(res){
                        if(res.status==1){
                            showSuccessMessage(res.info || '批量启用成功！');
                            setTimeout(function(){ location.reload(); }, 1000);
                        }else{
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 页码跳转功能
        $('#jumpButton').click(function () {
            var page = $('#jumpPage').val();
            if (page) {
                var url = new URL(window.location.href);
                url.searchParams.set('p', page);
                // 保持所有现有参数（包括排序参数）
                window.location.href = url.toString();
            }
        });

        // 单个删除（AJAX）
        $('.user-del-btn').click(function(){
            var id = $(this).data('id');
            var $this = $(this);
            if(confirm('确定删除?')){
                $.ajax({
                    url: '{:U("Customer/del", array("id"=>"__id__"))}'.replace('__id__', id),
                    type: 'get',
                    dataType: 'json',
                    success: function(res){
                        if(res.status==1){
                            showSuccessMessage(res.info || '删除成功！');
                            $this.closest('tr, .mobile-card').fadeOut(function(){
                                $(this).remove();
                            });
                        }else{
                            alert(res.info || '删除失败');
                        }
                    },
                    error: function(){
                        alert('请求失败，请重试');
                    }
                });
            }
        });

    })
</script>
</block>
<extend name="Public:base" />
<block name="title">用户列表</block>
<block name="content">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{:U('Admin/Index/index')}"><i class="fa fa-home"></i> 首页</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{:U('Admin/Index/index')}">后台管理</a>
            </li>
            <li class="breadcrumb-item active">用户列表</li>
        </ol>
    </nav>

    <div id="success-message" class="alert alert-success" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 9999;">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <span id="success-text"></span>
    </div>

    <div class="page-content">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs border-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="{:U('Admin/Customer/index')}">用户列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{:U('Admin/Customer/expiring')}">到期用户</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{:U('Admin/Customer/add')}">添加用户</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="search-bar">
                    <form method="post" class="search-bar" style="margin-bottom:0;">
                        <input type="text" name="search" placeholder="输入qq或任意订阅地址查询" value="{$data[0]['search']}">
                        <button class="btn btn-primary btn-sm" type="submit">搜索</button>
                    </form>
                </div>

                <div class="batch-toolbar">
                    <div class="batch-left">
                        <label><input type="checkbox" class="alls"> 全选</label>
                        <div id="allDel" class="btn btn-danger btn-sm">批量删除</div>
                        <div id="allPush" class="btn btn-success btn-sm">批量推送</div>
                        <div id="allDisable" class="btn btn-warning btn-sm">批量禁用</div>
                        <div id="allEnable" class="btn btn-info btn-sm">批量启用</div>
                    </div>
                </div>

                <div class="desktop-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" class="alls"></th>
                                <th>QQ号</th>
                                <th>邮箱</th>
                                <th>到期时间</th>
                                <th>状态</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <foreach name="data" item="v">
                                <tr>
                                    <td><input type="checkbox" class="all" name="all" value="{$v['id']}"></td>
                                    <td>{$v['username']}</td>
                                    <td>{$v['email']}</td>
                                    <td>{$v['endtime']|date='Y-m-d',###}</td>
                                    <td>
                                        <if condition="$v['status'] eq 1">
                                            <span class="status-badge status-active">启用</span>
                                        <else />
                                            <span class="status-badge status-disabled">禁用</span>
                                        </if>
                                    </td>
                                    <td>{$v['register_time']}</td>
                                    <td>
                                        <div class="action-group">
                                            <a class="btn btn-xs btn-warning" href="{:U('Admin/Customer/edit',array('id'=>$v['id']))}">编辑</a>
                                            <a class="btn btn-xs btn-danger user-del-btn" data-id="{$v['id']}" href="javascript:void(0);">删除</a>
                                            <if condition="$v['status'] eq 1">
                                                <a class="btn btn-xs btn-default" href="javascript:void(0);" onclick="toggleStatus({$v['id']},0)">禁用</a>
                                            <else />
                                                <a class="btn btn-xs btn-success" href="javascript:void(0);" onclick="toggleStatus({$v['id']},1)">启用</a>
                                            </if>
                                        </div>
                                    </td>
                                </tr>
                            </foreach>
                        </tbody>
                    </table>
                </div>

                <div class="mobile-card-list">
                    <foreach name="data" item="v">
                        <div class="mobile-card">
                            <input type="checkbox" class="all" name="all" value="{$v['id']}">
                            <div class="card-header-row">
                                <span class="card-title">{$v['username']}</span>
                                <if condition="$v['status'] eq 1">
                                    <span class="status-badge status-active">启用</span>
                                <else />
                                    <span class="status-badge status-disabled">禁用</span>
                                </if>
                            </div>
                            <div class="card-row">
                                <span class="label">QQ号</span>
                                <span class="value">{$v['username']}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">邮箱</span>
                                <span class="value">{$v['email']}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">到期时间</span>
                                <span class="value">{$v['endtime']|date='Y-m-d',###}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">注册时间</span>
                                <span class="value">{$v['register_time']}</span>
                            </div>
                            <div class="card-actions">
                                <a class="btn btn-xs btn-warning" href="{:U('Admin/Customer/edit',array('id'=>$v['id']))}">编辑</a>
                                <a class="btn btn-xs btn-danger user-del-btn" data-id="{$v['id']}" href="javascript:void(0);">删除</a>
                                <if condition="$v['status'] eq 1">
                                    <a class="btn btn-xs btn-default" href="javascript:void(0);" onclick="toggleStatus({$v['id']},0)">禁用</a>
                                <else />
                                    <a class="btn btn-xs btn-success" href="javascript:void(0);" onclick="toggleStatus({$v['id']},1)">启用</a>
                                </if>
                            </div>
                        </div>
                    </foreach>
                </div>

                <div class="page-footer">
                    <div class="pagination-info">共 {$totalCount} 条记录</div>
                    <div class="pagination-container">
                        <div class="pagination">{$page}</div>
                        <div class="pagination-jump">
                            <span>跳转到</span>
                            <input type="number" id="jumpPage" min="1" placeholder="页码">
                            <button id="jumpButton" class="btn btn-primary">确定</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="__PUBLIC__/statics/js/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(function () {
        function showSuccessMessage(message) {
            $('#success-text').text(message);
            $('#success-message').fadeIn().delay(3000).fadeOut();
        }

        $('.alls').change(function(){
            var checked = $(this).is(':checked');
            $('.all').prop('checked', checked);
        });

        // 批量删除
        $('#allDel').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ',' + $(this).val();
            });
            id = id.substr(1);
            if(id == ''){
                alert('请选择要删除的选项');
            } else {
                if(confirm('确定要删除选中的用户吗？此操作将删除用户的所有相关数据（订阅、订单、设备日志等）！')){
                    $.post("{:U('Customer/allDel')}", {id:id}, function(res){
                        if(res.status == 1){
                            showSuccessMessage(res.info || '批量删除成功！');
                            setTimeout(function(){ location.reload(); }, 1000);
                        } else {
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 批量推送
        $('#allPush').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ',' + $(this).val();
            });
            id = id.substr(1);
            if(id == ''){
                alert('请选择要推送的选项');
            } else {
                if(confirm('确定要推送选中的用户吗？')){
                    $.post("{:U('Customer/allPush')}", {id:id}, function(res){
                        if(res.status == 1){
                            showSuccessMessage(res.info || '批量推送成功！');
                        } else {
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 批量禁用
        $('#allDisable').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ',' + $(this).val();
            });
            id = id.substr(1);
            if(id == ''){
                alert('请选择要禁用的选项');
            } else {
                if(confirm('确定要禁用选中的用户吗？')){
                    $.post("{:U('Customer/allDisable')}", {id:id}, function(res){
                        if(res.status == 1){
                            showSuccessMessage(res.info || '批量禁用成功！');
                            setTimeout(function(){ location.reload(); }, 1000);
                        } else {
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 批量启用
        $('#allEnable').click(function(){
            var id = '';
            $('.all:checked').each(function(){
                id += ',' + $(this).val();
            });
            id = id.substr(1);
            if(id == ''){
                alert('请选择要启用的选项');
            } else {
                if(confirm('确定要启用选中的用户吗？')){
                    $.post("{:U('Customer/allEnable')}", {id:id}, function(res){
                        if(res.status == 1){
                            showSuccessMessage(res.info || '批量启用成功！');
                            setTimeout(function(){ location.reload(); }, 1000);
                        } else {
                            alert(res.info || '操作失败');
                        }
                    }, 'json');
                }
            }
        });

        // 页码跳转
        $('#jumpButton').click(function(){
            var page = $('#jumpPage').val();
            if(page){
                var url = new URL(window.location.href);
                url.searchParams.set('p', page);
                window.location.href = url.toString();
            }
        });

        // 单个删除（AJAX）
        $('.user-del-btn').click(function(){
            var id = $(this).data('id');
            var $this = $(this);
            if(confirm('确定删除?')){
                $.ajax({
                    url: '{:U("Customer/del", array("id"=>"__id__"))}'.replace('__id__', id),
                    type: 'get',
                    dataType: 'json',
                    success: function(res){
                        if(res.status == 1){
                            showSuccessMessage(res.info || '删除成功！');
                            $this.closest('tr, .mobile-card').fadeOut(function(){
                                $(this).remove();
                            });
                        } else {
                            alert(res.info || '删除失败');
                        }
                    },
                    error: function(){
                        alert('请求失败，请重试');
                    }
                });
            }
        });

    })
</script>
</block>
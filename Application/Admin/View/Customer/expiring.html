<extend name="Public:base" />
<block name="title">即将过期用户</block>
<block name="content">
    <nav class="breadcrumb">
        <div class="breadcrumb-item">
            <a href="{:U('Admin/Index/index')}"><i class="fa fa-home"></i> 首页</a>
        </div>
        <div class="breadcrumb-item">
            <a href="{:U('Admin/Index/index')}">后台管理</a>
        </div>
        <div class="breadcrumb-item active">即将过期用户</div>
    </nav>

    <div class="page-content">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link" href="{:U('Admin/Customer/index')}">用户列表</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{:U('Admin/Customer/expiring')}">到期用户</a></li>
                    <li class="nav-item"><a class="nav-link" href="{:U('Admin/Customer/add')}">添加用户</a></li>
                </ul>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>提醒：</strong>以下用户将在7天内过期，建议及时发送续费提醒邮件。
                </div>

                <div class="batch-toolbar">
                    <div class="batch-left">
                        <label><input type="checkbox" class="alls"> 全选</label>
                        <button type="button" id="batchReminder" class="btn btn-warning btn-sm"><i class="fa fa-envelope"></i> 批量过期提醒</button>
                        <button type="button" id="allPush" class="btn btn-success btn-sm"><i class="fa fa-paper-plane"></i> 批量发送邮件</button>
                        <button type="button" id="allDisable" class="btn btn-danger btn-sm"><i class="fa fa-ban"></i> 批量禁用</button>
                        <button type="button" id="allEnable" class="btn btn-primary btn-sm"><i class="fa fa-check"></i> 批量启用</button>
                    </div>
                </div>

                <div class="desktop-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="5%"><input type="checkbox" class="alls"></th>
                                <th width="10%">QQ号码</th>
                                <th><a href="{:U('Admin/Customer/expiring',['order'=>'endtime','type'=>$ordertype])}">过期时间</a></th>
                                <th>剩余天数</th>
                                <th>用户状态</th>
                                <th>激活状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <foreach name="data" item="v">
                                <tr>
                                    <td><input type="checkbox" name="all" class="all" value="{$v.id}"></td>
                                    <td>{$v['username']}</td>
                                    <td>{$v['endtime']}</td>
                                    <td>
                                        <if condition="$v['days_left'] lte 1">
                                            <span class="status-badge status-disabled">{$v['days_left']}天</span>
                                        <elseif condition="$v['days_left'] lte 3" />
                                            <span class="status-badge status-pending">{$v['days_left']}天</span>
                                        <else />
                                            <span class="status-badge status-info">{$v['days_left']}天</span>
                                        </if>
                                    </td>
                                    <td>{$v['user_status']}</td>
                                    <td>{$v['user_activation']}</td>
                                    <td>
                                        <div class="action-group">
                                            <a class="btn btn-xs btn-warning" href="{:U('Admin/Customer/renew',array('id'=>$v['id']))}"><i class="fa fa-refresh"></i> 续期</a>
                                            <a class="btn btn-xs btn-primary" href="{:U('Admin/Customer/sendmail',array('id'=>$v['id']))}"><i class="fa fa-envelope"></i> 发送提醒</a>
                                            <a class="btn btn-xs btn-info" href="{:U('Admin/Customer/edit',array('id'=>$v['id']))}"><i class="fa fa-edit"></i> 编辑</a>
                                        </div>
                                    </td>
                                </tr>
                            </foreach>
                        </tbody>
                    </table>
                </div>
                <div class="mobile-card-list">
                    <foreach name="data" item="v">
                        <div class="mobile-card">
                            <div class="card-header-row">
                                <span class="card-title">{$v['username']}</span>
                                <if condition="$v['days_left'] lte 1">
                                    <span class="status-badge status-disabled">{$v['days_left']}天</span>
                                <elseif condition="$v['days_left'] lte 3" />
                                    <span class="status-badge status-pending">{$v['days_left']}天</span>
                                <else />
                                    <span class="status-badge status-info">{$v['days_left']}天</span>
                                </if>
                            </div>
                            <div class="card-row">
                                <span class="label">邮箱</span>
                                <span class="value">{$v['email']}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">到期时间</span>
                                <span class="value">{$v['endtime']}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">剩余天数</span>
                                <span class="value">{$v['days_left']}天</span>
                            </div>
                            <div class="card-actions">
                                <a class="btn btn-warning btn-sm" href="{:U('Admin/Customer/renew',array('id'=>$v['id']))}"><i class="fa fa-refresh"></i> 续期</a>
                                <a class="btn btn-primary btn-sm" href="{:U('Admin/Customer/sendmail',array('id'=>$v['id']))}"><i class="fa fa-envelope"></i> 发送提醒</a>
                                <a class="btn btn-info btn-sm" href="{:U('Admin/Customer/edit',array('id'=>$v['id']))}"><i class="fa fa-edit"></i> 编辑</a>
                            </div>
                        </div>
                    </foreach>
                </div>

                <div class="page-footer">
                    <div class="pagination-info">共 {$totalCount} 条记录</div>
                    <div class="pagination-container">
                        <div class="pagination">{$page}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function () {
            // 全选功能
            $('.alls').change(function(){
                var check = $(this).prop('checked');
                $('.all').prop('checked', check);
            });

            // 批量发送过期提醒
            $('#batchReminder').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                });
                if(chk_value.length == 0){
                    alert('请选择要发送提醒的用户！');
                    return;
                }
                if(!confirm('确定向选中的 ' + chk_value.length + ' 个用户发送过期提醒邮件？')){
                    return;
                }
                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> 发送中...');
                $.ajax({
                    url: "{:U('Admin/Customer/batchExpireReminder')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '发送成功');
                        }else{
                            alert(res.info || '发送失败');
                        }
                        location.reload();
                    },
                    error: function(){
                        alert('发送失败，请稍后再试！');
                        $('#batchReminder').prop('disabled', false).html('<i class="fa fa-envelope"></i> 批量发送过期提醒');
                    }
                });
            });
            // 批量发送订阅邮件
            $('#allPush').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                });
                if(chk_value.length == 0){
                    alert('请选择要发送邮件的用户！');
                    return;
                }
                if(!confirm('确定向选中的 ' + chk_value.length + ' 个用户发送订阅邮件？')){
                    return;
                }
                $.ajax({
                    url: "{:U('Customer/allPush')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '发送成功');
                            location.reload();
                        }else{
                            alert(res.info || '发送失败，请稍后再试');
                        }
                    }
                });
            });

            // 批量禁用
            $('#allDisable').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                });
                if(chk_value.length == 0){
                    alert('请选择要禁用的用户！');
                    return;
                }
                if(!confirm('确定禁用选中的 ' + chk_value.length + ' 个用户？')){
                    return;
                }
                $.ajax({
                    url: "{:U('Customer/allDisable')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '禁用成功');
                            location.reload();
                        }else{
                            alert(res.info || '操作失败，请稍后再试');
                        }
                    }
                });
            });
            // 批量启用
            $('#allEnable').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                });
                if(chk_value.length == 0){
                    alert('请选择要启用的用户！');
                    return;
                }
                if(!confirm('确定启用选中的 ' + chk_value.length + ' 个用户？')){
                    return;
                }
                $.ajax({
                    url: "{:U('Customer/allEnable')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '启用成功');
                            location.reload();
                        }else{
                            alert(res.info || '操作失败，请稍后再试');
                        }
                    }
                });
            });
        });
    </script>
</block>

<extend name="Public:base" />
<block name="title">即将过期用户</block>
<block name="css">
    <style>
        /* 面包屑导航设计 */
        .breadcrumb {
            background: transparent;
            padding: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
        }
        
        .breadcrumb-item a {
            color: #1677ff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s ease;
        }
        
        .breadcrumb-item a:hover {
            color: #0958d9;
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: #8c8c8c;
        }
        
        .breadcrumb-item i {
            font-size: 14px;
        }
        
        .breadcrumb-item:not(:last-child)::after {
            content: '/';
            color: #d9d9d9;
            margin-left: 8px;
            font-size: 12px;
        }
        
        /* 选项卡样式 - 并排排列 */
        .nav-tabs {
            border-bottom: none;
            margin-bottom: 20px;
            background: transparent;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        
        .nav-tabs .nav-item {
            margin-right: 8px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #595959;
            padding: 12px 20px;
            border-radius: 6px;
            background: #f5f5f5;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .nav-tabs .nav-link.active {
            background: #1677ff;
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(22, 119, 255, 0.3);
        }
        
        .nav-tabs .nav-link:hover {
            background: #e6f7ff;
            color: #1677ff;
            transform: translateY(-1px);
        }
        
        /* 页面导航路径 */
        .page-navigation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .page-navigation .nav-item {
            display: flex;
            align-items: center;
            color: #6c757d;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .page-navigation .nav-item:hover {
            color: #1677ff;
            text-decoration: none;
        }
        
        .page-navigation .nav-item.active {
            color: #1677ff;
            font-weight: 500;
        }
        
        .page-navigation .nav-separator {
            color: #dee2e6;
            margin: 0 4px;
        }
        
        /* 响应式处理 */
        @media (max-width: 768px) {
            .breadcrumb {
                display: none !important;
            }
            
            .page-navigation {
                font-size: 12px;
                padding: 8px 12px;
                margin-bottom: 15px;
            }
        }
        /* 手机端样式 */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.1rem;
                padding: 10px 0;
            }
            .tabbable {
                padding: 0 5px;
            }
            
            /* 隐藏桌面端表格 */
            .table {
                display: none;
            }
            
            /* 手机端警告提示优化 */
            .alert {
                margin: 15px 0;
                padding: 15px;
                border-radius: 8px;
                font-size: 14px;
            }
            
            /* 手机端用户卡片 */
            .mobile-expiring-list {
                display: block;
            }
            
            .mobile-expiring-card {
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                margin-bottom: 20px;
                padding: 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                position: relative;
            }
            
            .mobile-expiring-card.urgent {
                border-left: 4px solid #dc3545;
                background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
            }
            
            .mobile-expiring-card.warning {
                border-left: 4px solid #ffc107;
                background: linear-gradient(135deg, #fff 0%, #fffbf0 100%);
            }
            
            .mobile-expiring-card.normal {
                border-left: 4px solid #17a2b8;
                background: linear-gradient(135deg, #fff 0%, #f0f8ff 100%);
            }
            
            .mobile-expiring-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
            }
            
            .mobile-expiring-qq {
                font-size: 18px;
                font-weight: bold;
                color: #2c3e50;
            }
            
            .mobile-expiring-days {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: bold;
            }
            
            .mobile-expiring-days.urgent {
                background: #dc3545;
                color: #fff;
            }
            
            .mobile-expiring-days.warning {
                background: #ffc107;
                color: #212529;
            }
            
            .mobile-expiring-days.normal {
                background: #17a2b8;
                color: #fff;
            }
            
            .mobile-expiring-content {
                margin-bottom: 20px;
            }
            
            .mobile-expiring-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                font-size: 14px;
                padding: 8px 0;
            }
            
            .mobile-expiring-label {
                color: #666;
                font-weight: 500;
                flex: 1;
            }
            
            .mobile-expiring-value {
                color: #333;
                text-align: right;
                flex: 1;
            }
            
            .mobile-expiring-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-top: 20px;
            }
            
            .mobile-expiring-actions .btn {
                font-size: 13px;
                padding: 12px 8px;
                margin: 0;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }
            
            .mobile-expiring-actions .btn i {
                font-size: 12px;
            }
            
            /* 批量操作按钮优化 */
            .form-actions {
                margin: 20px 0;
            }
            
            .btn-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .btn-group .btn {
                font-size: 13px;
                padding: 12px 8px;
                margin: 0;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }
            
            .btn-group .btn i {
                font-size: 12px;
            }
            
            /* 分页优化 */
            .pagination {
                text-align: center;
                margin: 20px 0;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 8px;
            }
            .pagination a, .pagination span {
                padding: 12px 16px;
                margin: 0;
                font-size: 14px;
                border-radius: 8px;
                border: 1px solid #dee2e6;
                background: #fff;
                color: #333;
                text-decoration: none;
                min-width: 44px;
                text-align: center;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }
            .pagination a:hover {
                background: #f8f9fa;
                border-color: #42a5f5;
                color: #42a5f5;
            }
            .pagination span.current {
                background: #42a5f5;
                color: #fff;
                border-color: #42a5f5;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-expiring-list {
                display: none;
            }
        }
        
        /* 手机端导航标签样式优化 */
        @media (max-width: 768px) {
            .nav-tabs {
                display: flex;
                background: #fff;
                border-bottom: 2px solid #e9ecef;
                margin-bottom: 20px;
                border-radius: 8px 8px 0 0;
                overflow: hidden;
            }
            
            .nav-tabs li {
                flex: 1;
                margin: 0;
            }
            
            .nav-tabs li a {
                display: block;
                padding: 15px 10px;
                text-align: center;
                font-size: 16px;
                font-weight: 500;
                color: #666;
                background: #f8f9fa;
                border: none;
                border-radius: 0;
                text-decoration: none;
                transition: all 0.3s ease;
                border-bottom: 3px solid transparent;
            }
            
            .nav-tabs li.active a {
                background: #42a5f5;
                color: #fff;
                border-bottom-color: #1976d2;
            }
            
            .nav-tabs li a:hover {
                background: #e3f2fd;
                color: #1976d2;
            }
        }
    </style>
</block>
<block name="content">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{:U('Admin/Index/index')}">
                    <i class="fa fa-home"></i>
                    首页
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{:U('Admin/Index/index')}">
                    后台管理
                </a>
            </li>
            <li class="breadcrumb-item active">
                即将过期用户
            </li>
        </ol>
    </nav>
    
    <!-- 页面导航路径 -->
    <div class="page-navigation">
        <a href="{:U('Admin/Index/index')}" class="nav-item">
            <i class="fa fa-home"></i>
            首页
        </a>
        <div class="nav-separator">/</div>
        <a href="{:U('Admin/Index/index')}" class="nav-item">
            后台管理
        </a>
        <div class="nav-separator">/</div>
        <div class="nav-item active">
            即将过期用户
        </div>
    </div>
    
    <div class="col-xs-12">
        <div class="tabbable">
            <ul class="nav nav-tabs padding-12 tab-color-blue background-blue" id="myTab">
                <li> <a href="{:U('Admin/Customer/list')}">用户列表</a></li>
                <li class="active"> <a href="{:U('Admin/Customer/expiring')}">即将过期用户</a></li>
                <li> <a href="{:U('Admin/Customer/add')}">添加用户</a></li>
            </ul>
            <div class="tab-content">
                <div class="alert alert-warning">
                    <strong>提醒：</strong>以下用户将在7天内过期，建议及时发送续费提醒邮件。
                </div>
                
                <!-- 桌面端表格 -->
                <table class="table table-striped table-bordered table-hover table-condensed">
                    <tr>
                        <th width="5%"><input type="checkbox" class="alls"> 全选</th>
                        <th width="10%">QQ号码</th>
                        <th><a href="{:U('Admin/Customer/expiring',['order'=>'endtime','type'=>$ordertype])}">过期时间</a></th>
                        <th>剩余天数</th>
                        <th>用户状态</th>
                        <th>激活状态</th>
                        <th>操作</th>
                    </tr>
                    <foreach name="data" item="v">
                        <tr class="{$v.days_left <= 1 ? 'danger' : ($v.days_left <= 3 ? 'warning' : '')}">
                            <td><input type="checkbox" class="all" name="all" value="{$v['id']}"></td>
                            <td width="10%">{$v['qq']}</td>
                            <td>{$v['endtime_formatted']}</td>
                            <td>
                                <span class="label {$v.days_left <= 1 ? 'label-danger' : ($v.days_left <= 3 ? 'label-warning' : 'label-info')}">
                                    {$v['days_left']}天
                                </span>
                            </td>
                            <td>{$v['user_status']}</td>
                            <td>{$v['user_activation']}</td>
                            <td>
                                <a href="{:U('Admin/Customer/sendmail',array('id'=>$v['id']))}" class="btn btn-xs btn-primary">发送邮件</a>
                                <a href="{:U('Admin/Customer/edit',array('id'=>$v['id']))}" class="btn btn-xs btn-info">修改</a>
                            </td>
                        </tr>
                    </foreach>
                </table>
                
                <!-- 手机端即将过期用户卡片列表 -->
                <div class="mobile-expiring-list">
                    <foreach name="data" item="v">
                        <div class="mobile-expiring-card {$v.days_left <= 1 ? 'urgent' : ($v.days_left <= 3 ? 'warning' : 'normal')}">
                            <input type="checkbox" class="mobile-expiring-checkbox all" name="all" value="{$v['id']}">
                            
                            <div class="mobile-expiring-header">
                                <div class="mobile-expiring-qq">{$v['qq']}</div>
                                <div class="mobile-expiring-days {$v.days_left <= 1 ? 'urgent' : ($v.days_left <= 3 ? 'warning' : 'normal')}">
                                    {$v['days_left']}天
                                </div>
                            </div>
                            
                            <div class="mobile-expiring-content">
                                <div class="mobile-expiring-row">
                                    <span class="mobile-expiring-label">过期时间:</span>
                                    <span class="mobile-expiring-value">{$v['endtime_formatted']}</span>
                                </div>
                                <div class="mobile-expiring-row">
                                    <span class="mobile-expiring-label">用户状态:</span>
                                    <span class="mobile-expiring-value">{$v['user_status']}</span>
                                </div>
                                <div class="mobile-expiring-row">
                                    <span class="mobile-expiring-label">激活状态:</span>
                                    <span class="mobile-expiring-value">{$v['user_activation']}</span>
                                </div>
                            </div>
                            
                            <div class="mobile-expiring-actions">
                                <a class="btn btn-xs btn-primary" href="{:U('Admin/Customer/sendmail',array('id'=>$v['id']))}">
                                    <i class="fa fa-envelope"></i> 发送邮件
                                </a>
                                <a class="btn btn-xs btn-info" href="{:U('Admin/Customer/edit',array('id'=>$v['id']))}">
                                    <i class="fa fa-edit"></i> 修改
                                </a>
                            </div>
                        </div>
                    </foreach>
                </div>
                
                <!-- 批量操作 -->
                <div style="margin:10px 0;">
                    <span class="inputword">全选</span> <input type="checkbox" class="alls">
                </div>
                
                <div class="form-actions">
                    <div class="btn-group">
                        <button type="button" id="batchReminder" class="btn btn-warning">
                            <i class="fa fa-envelope"></i> 批量发送过期提醒
                        </button>
                        <button type="button" id="allPush" class="btn btn-success">
                            <i class="fa fa-paper-plane"></i> 批量发送订阅邮件
                        </button>
                        <button type="button" id="allDisable" class="btn btn-danger">
                            <i class="fa fa-ban"></i> 批量禁用
                        </button>
                        <button type="button" id="allEnable" class="btn btn-primary">
                            <i class="fa fa-check"></i> 批量启用
                        </button>
                    </div>
                </div>
            </div>
            <div class="pagination">{$page}</div>
        </div>
    </div>
    
    <script src="__PUBLIC__/statics/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        $(function () {
            // 全选功能
            $('.alls').change(function(){
                var check = $(this).prop('checked');
                $('.all').prop('checked',check);
            })
            
            // 批量发送过期提醒
            $('#batchReminder').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                })
                
                if(chk_value.length == 0){
                    alert('请选择要发送提醒的用户！');
                    return;
                }
                
                if(!confirm('确定向选中的 ' + chk_value.length + ' 个用户发送过期提醒邮件？')){
                    return;
                }
                
                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> 发送中...');
                
                $.ajax({
                    url: "{:U('Admin/Customer/batchExpireReminder')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '发送成功');
                        }else{
                            alert(res.info || '发送失败');
                        }
                        location.reload();
                    },
                    error: function(){
                        alert('发送失败，请稍后再试！');
                        $('#batchReminder').prop('disabled', false).html('<i class="fa fa-envelope"></i> 批量发送过期提醒');
                    }
                })
            })

            // 批量发送订阅邮件
            $('#allPush').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                })

                if(chk_value.length == 0){
                    alert('请选择要发送邮件的用户！');
                    return;
                }

                if(!confirm('确定向选中的 ' + chk_value.length + ' 个用户发送订阅邮件？')){
                    return;
                }

                $.ajax({
                    url: "{:U('Admin/Customer/allPush')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '发送成功');
                            location.reload();
                        }else{
                            alert(res.info || '发送失败，请稍后再试');
                        }
                    }
                })
            })

            // 批量禁用
            $('#allDisable').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                })

                if(chk_value.length == 0){
                    alert('请选择要禁用的用户！');
                    return;
                }

                if(!confirm('确定禁用选中的 ' + chk_value.length + ' 个用户？')){
                    return;
                }

                $.ajax({
                    url: "{:U('Admin/Customer/allDisable')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '禁用成功');
                            location.reload();
                        }else{
                            alert(res.info || '操作失败，请稍后再试');
                        }
                    }
                })
            })

            // 批量启用
            $('#allEnable').click(function () {
                var chk_value = [];
                $('input[name="all"]:checked').each(function(){
                    chk_value.push($(this).val());
                })

                if(chk_value.length == 0){
                    alert('请选择要启用的用户！');
                    return;
                }

                if(!confirm('确定启用选中的 ' + chk_value.length + ' 个用户？')){
                    return;
                }

                $.ajax({
                    url: "{:U('Admin/Customer/allEnable')}",
                    type:'post',
                    dataType:'json',
                    data:{id:chk_value.join(',')},
                    success:function(res){
                        if(res.status==1){
                            alert(res.info || '启用成功');
                            location.reload();
                        }else{
                            alert(res.info || '操作失败，请稍后再试');
                        }
                    }
                })
            })
        })
    </script>
</block>
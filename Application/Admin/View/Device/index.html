<extend name="Public:base" />
<block name="title">设备管理</block>
<block name="content">
    <style>
        .fp-text { font-family:monospace; font-size:12px; color:#595959; }
        .stat-card:nth-child(2) .stat-num { color:#10b981; }
        .stat-card:nth-child(3) .stat-num { color:#7c3aed; }
        .stat-card:nth-child(4) .stat-num { color:#f59e0b; }
    </style>
    <nav class="breadcrumb">
        <span class="breadcrumb-item"><a href="{:U('Admin/Index/index')}"><i class="fa fa-home"></i> 首页</a></span>
        <span class="breadcrumb-item active">设备管理</span>
    </nav>
    <div class="page-content">
        <!-- Stats cards -->
        <div class="stats-row">
            <div class="stat-card"><div class="stat-num" id="stat-total">-</div><div class="stat-label">总设备数</div></div>
            <div class="stat-card"><div class="stat-num" id="stat-users">-</div><div class="stat-label">独立用户</div></div>
            <div class="stat-card"><div class="stat-num" id="stat-devices">-</div><div class="stat-label">独立设备</div></div>
            <div class="stat-card"><div class="stat-num" id="stat-active">-</div><div class="stat-label">24h活跃</div></div>
        </div>

        <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-weight:600;">设备日志列表</span>
                <span style="font-size:13px;color:#8c8c8c;">共 {$total} 条记录</span>
            </div>
            <div class="card-body">
                <form method="get" action="{:U('Admin/Device/index')}" class="search-bar">
                    <input type="text" name="search" value="{$search}" placeholder="搜索 QQ / IP / UA / 设备指纹">
                    <button class="btn btn-primary" type="submit">搜索</button>
                    <if condition="$search">
                        <a class="btn btn-default" href="{:U('Admin/Device/index')}">清除</a>
                    </if>
                </form>
                <!-- 桌面端表格 -->
                <div class="desktop-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="4%">ID</th>
                                <th width="10%">QQ号</th>
                                <th width="10%">客户端</th>
                                <th class="hide-mobile">设备指纹</th>
                                <th width="12%">IP</th>
                                <th width="7%">历史IP</th>
                                <th width="14%">最后活跃</th>
                                <th width="14%">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <foreach name="list" item="v">
                            <tr>
                                <td>{$v['id']}</td>
                                <td>{$v['qq']}</td>
                                <td>{$v['client']}</td>
                                <td class="hide-mobile"><span class="fp-text" title="{$v['fingerprint']}">{$v['fp_short']}</span></td>
                                <td title="{$v['ip']}">{$v['ip_display']}</td>
                                <td>{$v['ip_count']}</td>
                                <td>{$v['last_seen_fmt']}</td>
                                <td>
                                    <div class="action-group">
                                        <a class="btn btn-xs btn-info" href="{:U('Admin/Device/detail',array('id'=>$v['id']))}">详情</a>
                                        <a class="btn btn-xs btn-danger" onclick="return confirm('确定删除该记录?');" href="{:U('Admin/Device/del',array('id'=>$v['id']))}">删除</a>
                                    </div>
                                </td>
                            </tr>
                            </foreach>
                        </tbody>
                    </table>
                </div>
                <!-- 移动端卡片 -->
                <div class="mobile-card-list">
                    <foreach name="list" item="v">
                    <div class="mobile-card">
                        <div class="card-header-row">
                            <span class="card-title">{$v['qq']}</span>
                        </div>
                        <div class="card-row"><span class="label">客户端</span><span class="value">{$v['client']}</span></div>
                        <div class="card-row"><span class="label">IP</span><span class="value" title="{$v['ip']}">{$v['ip_display']}</span></div>
                        <div class="card-row"><span class="label">历史IP</span><span class="value">{$v['ip_count']}</span></div>
                        <div class="card-row"><span class="label">最后活跃</span><span class="value">{$v['last_seen_fmt']}</span></div>
                        <div class="card-actions">
                            <a class="btn btn-info" href="{:U('Admin/Device/detail',array('id'=>$v['id']))}">详情</a>
                            <a class="btn btn-danger" onclick="return confirm('确定删除该记录?');" href="{:U('Admin/Device/del',array('id'=>$v['id']))}">删除</a>
                        </div>
                    </div>
                    </foreach>
                </div>
                <!-- 分页 -->
                <div class="page-footer">
                    <div class="pagination-info">共 {$total} 条记录</div>
                    <div class="pagination-container">
                        <div class="pagination">{$page}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="__PUBLIC__/statics/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
    $(function(){
        $.ajax({
            url: "{:U('Admin/Device/stats')}",
            type: 'get',
            dataType: 'json',
            success: function(res) {
                if (res.code == 0 && res.data) {
                    $('#stat-total').text(res.data.total);
                    $('#stat-users').text(res.data.unique_users);
                    $('#stat-devices').text(res.data.unique_devices);
                    $('#stat-active').text(res.data.active_24h);
                }
            }
        });
    });
    </script>
</block>

<extend name="Public:layout" />

<block name="title">套餐管理</block>

<block name="head">
    <link rel="stylesheet" href="/Public/statics/css/all.min.css">
    <script src="/Public/statics/js/wechat-detect.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 40px;
        }

        /* 主内容区域 */
        .page-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .page-header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: var(--color-primary);
        }

        .page-header p {
            color: #666;
            font-size: 1.1rem;
        }

        /* 卡片样式 */
        .card {
            background: var(--color-bg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: 25px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .card-header {
            padding: 20px;
            background: rgba(22, 119, 255, 0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-body {
            padding: 25px;
        }

        /* 套餐选择区域 */
        .plan-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .plan-card {
            border: 2px solid #e0e6ed;
            border-radius: var(--radius-xl);
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .plan-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 5px 15px rgba(22, 119, 255, 0.15);
        }

        .plan-card.selected {
            border-color: var(--color-primary);
            background: rgba(22, 119, 255, 0.05);
            transform: scale(1.02);
        }

        .plan-card .recommended {
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--color-warning);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .plan-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--color-primary);
        }

        .plan-card .price {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 15px 0;
            color: var(--color-primary);
        }

        .plan-card .price span {
            font-size: 1rem;
            font-weight: normal;
            color: #777;
        }

        .plan-card .features {
            list-style: none;
            padding: 15px 0;
            margin: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .plan-card .features li {
            padding: 8px 0;
            color: #555;
        }

        /* 支付方式 */
        .payment-methods {
            margin: 30px 0;
        }

        .payment-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .payment-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .payment-option {
            flex: 1;
            min-width: 200px;
            border: 2px solid #e0e6ed;
            border-radius: var(--radius-xl);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: var(--color-primary);
        }

        .payment-option.selected {
            border-color: var(--color-primary);
            background: rgba(22, 119, 255, 0.05);
        }

        .payment-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(25, 118, 210, 0.1);
            border-radius: 10px;
            font-size: 1.8rem;
            color: #1976d2;
        }

        .alipay-icon {
            background: rgba(0, 120, 215, 0.1);
            color: #0078d7;
        }

        .wechat-icon {
            background: rgba(7, 193, 96, 0.1);
            color: #07c160;
        }

        .payment-info h4 {
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .payment-info p {
            color: #777;
            font-size: 0.9rem;
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 119, 255, 0.3);
        }

        .btn-lg {
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .btn-block {
            display: flex;
            width: 100%;
            margin-top: 20px;
        }

        .btn-success {
            background: var(--color-success);
        }

        .btn-success:hover {
            background: #388e3c;
        }

        /* 订阅信息 */
        .subscription-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            flex: 1;
            min-width: 250px;
            background: linear-gradient(135deg, var(--color-primary-active), #4a69dd);
            color: white;
            padding: 25px;
            border-radius: var(--radius-xl);
            text-align: center;
            box-shadow: 0 5px 15px rgba(103, 119, 239, 0.3);
        }

        .info-card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .info-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .info-card .note {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-top: 15px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .plan-container {
                grid-template-columns: 1fr;
            }

            .payment-options {
                flex-direction: column;
            }

            .subscription-info {
                flex-direction: column;
            }

            .card-header {
                padding: 15px;
            }

            .card-body {
                padding: 20px;
            }
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* 公告样式 */
        .announcement {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .announcement strong {
            color: #e65100;
        }
    </style>
</block>

<block name="content">
    <div class="container">
        <div class="card fade-in" style="margin-top: 30px">
            <div class="card-header">
                <i class="fas fa-qrcode"></i>
                支付宝扫码支付
            </div>
            <div class="card-body text-center" style=" text-align: center; ">
                <!-- 二维码显示 -->
                <div id="qrcode-container">
                    <if condition="$list.path">
                        <!-- 使用Base64编码的本地二维码 -->
                        <img src="{$list.path}" alt="支付宝支付二维码" style="width: 200px; height: 200px; border: 2px solid #eee; border-radius: 8px;">
                    <else/>
                        <!-- 二维码生成失败提示 -->
                        <div style="padding: 20px; color: #ff5722;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>二维码生成失败，请刷新页面重试</p>
                        </div>
                    </if>
                </div>

                <!-- 移动端跳转支付宝按钮 -->
                <div id="mobile-pay-button" style="display: none; margin: 20px 0;">
                    <a href="javascript:void(0)" id="alipay-app-link" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #1677FF 0%, #0958D9 100%); color: #fff; text-decoration: none; border-radius: 25px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(22, 119, 255, 0.3); transition: all 0.3s;">
                        <i class="fas fa-mobile-alt" style="margin-right: 8px;"></i>
                        打开支付宝APP支付
                    </a>
                </div>

                <!-- 订单信息 -->
                <div class="payment-info" style="margin: 20px 0">
                    <h3 style="color: #ff6f00; margin-bottom: 15px">订单号：{$list.order_no}</h3>
                     <h3 style="color: #ff6f00; margin-bottom: 15px">金额：{$list.price}</h3>
                    <p style="color: #666; font-size: 1.1rem">
                        <i class="fas fa-clock"></i>
                        订单有效期：<span id="countdown" style="color: #ff5722; font-weight: 600">5:00</span> 分钟
                    </p>
                </div>

                <!-- 操作提示 -->
                <div class="announcement" style="background: #e8f5e9; border-color: #4caf50">
                    <p style=" text-align: left; "><strong>支付步骤：</strong></p>
                    <ol style="text-align: left; padding-left: 20px; line-height: 2">
                        <li>打开手机支付宝APP</li>
                        <li>点击"扫一扫"扫描上方二维码</li>
                        <li>确认订单信息并完成支付</li>
                        <li>支付成功后页面将自动跳转</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</block>

<block name="footer">
<script>
        // 全局变量
        let expireTime; // 订单过期的时间戳
        let countdownInterval; // 倒计时计时器
        let orderNo; // 订单号
        let isPageVisible = true; // 页面是否可见
        let qrCodeContent = '{$list.qr_code}'; // 二维码原始内容，用于跳转支付宝app

        // 检测是否为移动设备
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // 跳转到支付宝APP
        function openAlipayApp() {
            if (!qrCodeContent) {
                alert('二维码内容不存在，无法跳转');
                return;
            }

            // 支付宝app跳转URL格式
            const alipayUrl = 'alipays://platformapi/startapp?saId=10000007&qrcode=' + encodeURIComponent(qrCodeContent);

            // 尝试跳转
            window.location.href = alipayUrl;

            // 如果3秒后还在当前页面，说明没有安装支付宝app，提示用户
            setTimeout(function() {
                if (document.hasFocus()) {
                    alert('未检测到支付宝APP，请先安装支付宝APP或使用扫码支付');
                }
            }, 3000);
        }

        // 页面加载时检测移动端并显示按钮
        function initMobilePayButton() {
            if (isMobileDevice() && qrCodeContent) {
                document.getElementById('mobile-pay-button').style.display = 'block';
                document.getElementById('alipay-app-link').onclick = function(e) {
                    e.preventDefault();
                    openAlipayApp();
                };
            }
        }

        // 启动倒计时
        function startCountdown() {
            // 清除现有计时器
            if (countdownInterval) clearInterval(countdownInterval);

            // 计算剩余时间（秒）
            const now = Date.now();
            const remainingSeconds = Math.max(0, Math.floor((expireTime - now) / 1000));

            // 更新倒计时显示
            updateCountdownDisplay(remainingSeconds);

            // 如果订单已过期
            if (remainingSeconds <= 0) {
                handleOrderExpired(orderNo);
                return;
            }

            // 设置每秒更新一次的计时器
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const remainingSeconds = Math.max(0, Math.floor((expireTime - now) / 1000));

                updateCountdownDisplay(remainingSeconds);

                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    handleOrderExpired(orderNo);
                }
            }, 1000);
        }

        // 更新倒计时显示
        function updateCountdownDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;

            // 格式化显示为 MM:SS
            const displayText =
                minutes.toString().padStart(2, '0') + ':' +
                remainingSeconds.toString().padStart(2, '0');

            document.getElementById('countdown').textContent = displayText;

            // 最后1分钟变为红色
            if (seconds <= 60) {
                document.getElementById('countdown').style.color = '#ff0000';
            } else {
                document.getElementById('countdown').style.color = '#ff5722';
            }
        }

        // 页面可见性变化处理
        function handleVisibilityChange() {
            if (document.visibilityState === 'visible') {
                // 页面变为可见
                isPageVisible = true;

                // 重新启动倒计时（使用准确的时间）
                startCountdown();

                // 显示提示信息（3秒后消失）
                const warning = document.getElementById('time-warning');
                warning.style.display = 'block';
                setTimeout(() => {
                    warning.style.display = 'none';
                }, 3000);
            } else {
                // 页面变为不可见
                isPageVisible = false;
            }
        }

        // 处理订单过期
        function handleOrderExpired(orderNo) {
            document.getElementById('countdown').textContent = "已过期";
            document.getElementById('countdown').style.color = '#ff0000';

            // 更新订单状态
            fetch('/qx', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order_no: orderNo })
            })
            .then(response => {
                if (response.ok) {
                    // 3秒后跳转首页
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    alert('订单处理失败，请联系客服');
                }
            })
            .catch(error => {
                console.error('状态更新失败:', error);
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            });
        }

        // 检查支付状态
        function checkPaymentStatus(orderNo) {
            if (!isPageVisible) return; // 如果页面不可见，不检查支付状态

            fetch(`/return?order_no=${orderNo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.paid) {
                        window.location.href = '/'; // 支付成功跳转
                    }
                })
                .catch(error => console.error('支付检查失败:', error));
        }

        window.onload = function () {
            // 初始化移动端支付按钮
            initMobilePayButton();

            // 获取订单号
            const orderNoElement = document.querySelector('.payment-info h3');
            orderNo = orderNoElement.textContent.replace('订单号：', '').trim();

            // 设置订单过期时间（当前时间 + 5分钟）
            const now = Date.now();
            expireTime = now + (5 * 60 * 1000);

            // 启动倒计时
            startCountdown();

            // 启动支付状态检查（每5秒检查一次）
            const checkInterval = setInterval(() => checkPaymentStatus(orderNo), 5000);

            // 监听页面可见性变化
            document.addEventListener('visibilitychange', handleVisibilityChange);
        };
</script>
</block>

<extend name="Public:layout" />

<block name="title">è®¢é˜…åœ°å€è·å–</block>

<block name="head">
    <link rel="stylesheet" href="/Public/statics/user/iconfont.css">
    <link rel="stylesheet" href="/Public/statics/user/cur.min.css">
    <link rel="stylesheet" href="/Public/statics/user/layui.css">
    <link rel="stylesheet" href="/Public/statics/user/dropdown.css">
    <script src="/Public/statics/js/kjua-0.9.0.min.js"></script>
    <script src="/Public/statics/js/wechat-detect.js"></script>
    <style>
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 20px;
        }

        .page-header {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #fff;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .stats-card {
            background: linear-gradient(45deg, var(--color-primary-active), #4a69dd);
            color: #fff;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 1rem 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .expiry-date {
            background: rgba(255,255,255,0.2);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 1.1rem;
            margin-top: 1rem;
        }

        .expiry-warning {
            color: #ffd700;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-control {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .table th,
        .table td {
            padding: 1rem;
            border-bottom: 1px solid #edf2f7;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .input-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-top:20px ;
            }

            .card-header {
                padding: 1rem;
            }

            .card-body {
                padding: 1rem;
            }
        }

        @media (max-width: 992px) {
            .plan-container {
                grid-template-columns: 1fr;
            }

            .payment-options {
                flex-direction: column;
            }

            .payment-option {
                width: 100%;
            }

            .subscription-info {
                flex-direction: column;
            }

            .card-header {
                padding: 15px;
            }

            .card-body {
                padding: 20px;
            }
        }

        /* å®¢æˆ·ç«¯ä¸‹è½½å¡ç‰‡æ ·å¼ */
        .client-card {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--color-bg-page);
            border-radius: 8px;
        }

        .client-card.active {
            display: block;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--color-primary);
            color: #fff;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: var(--color-primary-hover);
        }

        /* å¤åˆ¶æç¤ºæ ·å¼ */
        .copy-tooltip {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            z-index: 1000;
            display: none;
        }

        .copy-tooltip.show {
            display: block;
            animation: fadeInOut 2s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 1rem); }
            15% { opacity: 1; transform: translate(-50%, 0); }
            85% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -1rem); }
        }

        @media (max-width: 768px) {
            .client-card {
                margin: 0.5rem;
            }
        }

        /* å®¢æˆ·ç«¯ä¸‹è½½åŒºåŸŸæ ·å¼ */
        .client-downloads {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #edf2f7;
        }

        .download-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--color-bg-page);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .download-item:last-child {
            margin-bottom: 0;
        }

        .download-item span {
            font-weight: 500;
        }

        .download-item .notice {
            color: #666;
            font-size: 0.9rem;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--color-primary);
            color: #fff;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .download-item {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }
        }

        /* é‚®ä»¶å‘é€æˆåŠŸå¼¹çª— */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: flex-end;
            align-items: flex-end;
            padding: 20px;
        }
        .custom-modal.show { display: flex; }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            text-align: center;
            width: 360px;
            max-width: 90%;
            animation: modal-pop 0.3s ease-out;
        }
        .icon-wrapper {
            width: 70px; height: 70px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-wrapper.success { background-color: #e8f5e9; }
        .icon-wrapper.success i { color: #4CAF50; font-size: 40px; }
        .icon-wrapper.warning { background-color: #fff8e1; }
        .icon-wrapper.warning i { color: #ffa000; font-size: 40px; }
        .modal-content h3 { font-size: 22px; font-weight: 600; color: #333; margin: 0 0 10px; }
        .modal-content p { font-size: 16px; color: #777; margin: 0 0 25px; }
        .modal-btn {
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 110px;
        }
        .modal-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .modal-btn.secondary { background-color: #f1f1f1; color: #555; }
        .modal-btn.danger { background-color: #f44336; color: #fff; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        @keyframes modal-pop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    /* ç»Ÿä¸€å¼¹çª—é£æ ¼ */
    .unified-modal {
        width: 380px;
        max-width: 95vw;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(22, 119, 255, 0.18);
        padding: 32px 24px 24px 24px;
        background: #fff;
        text-align: center;
        font-family: 'Segoe UI', 'PingFang SC', Arial, sans-serif;
    }
    .unified-icon {
        width: 64px; height: 64px;
        margin: 0 auto 18px auto;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-primary) 60%, var(--color-primary-active) 100%);
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 8px rgba(22, 119, 255, 0.12);
    }
    .unified-icon i {
        color: #fff;
        font-size: 36px;
    }
    .unified-icon.warning {
        background: linear-gradient(135deg, #ffd600 60%, #ff9800 100%);
    }
    .unified-modal h3 {
        font-size: 22px;
        font-weight: 700;
        color: var(--color-primary-active);
        margin: 0 0 10px 0;
    }
    .unified-modal p {
        font-size: 15px;
        color: #555;
        margin: 0 0 22px 0;
    }
    .unified-btn {
        border: none;
        border-radius: 8px;
        padding: 12px 28px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(90deg, var(--color-primary) 60%, var(--color-primary-active) 100%);
        color: #fff;
        margin: 0 8px;
        box-shadow: 0 2px 8px rgba(22, 119, 255, 0.10);
        transition: background 0.2s, box-shadow 0.2s;
    }
    .unified-btn:hover {
        background: linear-gradient(90deg, var(--color-primary-active) 60%, var(--color-primary) 100%);
        box-shadow: 0 4px 16px rgba(22, 119, 255, 0.18);
    }
    .unified-btn.secondary {
        background: #f1f1f1;
        color: var(--color-primary-active);
        box-shadow: none;
    }
    .unified-btn.danger {
        background: linear-gradient(90deg, #ff9800 60%, #ffd600 100%);
        color: #fff;
    }
    .modal-buttons { display: flex; justify-content: center; gap: 15px; }
    @media (max-width: 480px) {
        .unified-modal { padding: 18px 4vw 18px 4vw; }
        .unified-btn { width: 100%; margin: 8px 0; }
        .modal-buttons { flex-direction: column; gap: 8px; }
    }
    /* è®¾å¤‡ç®¡ç†æ ·å¼ */
    .device-count-badge {
        background: var(--color-primary);
        color: #fff;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
    }

    .device-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .device-actions .btn {
        flex: 1;
        min-width: 140px;
    }

    .device-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: var(--color-bg-page);
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #e0e6ed;
        transition: all 0.2s ease;
    }

    .device-item:hover {
        background: #f0f7ff;
        border-color: var(--color-primary);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(22, 119, 255, 0.1);
    }

    .device-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    /* è®¾å¤‡logoæ ·å¼ */
    .device-logo {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        flex-shrink: 0;
    }
    /* è½¯ä»¶logoé¢œè‰² */
    .device-logo.shadowrocket { background: linear-gradient(135deg, #ff6b35, #ff8c42); }
    .device-logo.clash { background: linear-gradient(135deg, #4a90e2, #357abd); }
    .device-logo.v2ray { background: linear-gradient(135deg, #7b68ee, #6a5acd); }
    .device-logo.quantumult { background: linear-gradient(135deg, #ff4757, #ff3742); }
    .device-logo.surge { background: linear-gradient(135deg, #2ed573, #20bf6b); }
    .device-logo.loon { background: linear-gradient(135deg, #ffa502, #ff9500); }
    .device-logo.stash { background: linear-gradient(135deg, #ff6348, #ff5722); }
    .device-logo.sparkle { background: linear-gradient(135deg, #ff9ff3, #ff69b4); }
    .device-logo.flclash { background: linear-gradient(135deg, #4a90e2, #357abd); }
    .device-logo.default { background: linear-gradient(135deg, #747d8c, #57606f); }

    .device-details {
        flex: 1;
    }

    .device-name {
        font-weight: 600;
        color: var(--color-text);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .device-meta {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
    }

    .device-ip {
        font-family: 'Courier New', monospace;
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 8px;
    }

    .device-actions-btns {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .device-remove-btn {
        background: #ff5722;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .device-remove-btn:hover {
        background: #d32f2f;
        transform: translateY(-1px);
    }

    .device-software {
        background: var(--color-primary);
        color: #fff;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        margin-top: 4px;
        display: inline-block;
    }

    .device-last-seen {
        color: #999;
        font-size: 11px;
        margin-top: 2px;
    }

    @media (max-width: 768px) {
        .device-item {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .device-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .device-actions-btns {
            justify-content: center;
        }

        .device-actions .btn {
            min-width: auto;
            flex: 1;
        }
    }
    </style>
</block>

<block name="content">
    <!-- ç»Ÿä¸€é£æ ¼çš„è‡ªå®šä¹‰å¼¹çª— -->
    <div id="emailSuccessModal" class="custom-modal">
        <div class="modal-content unified-modal">
            <div class="icon-wrapper unified-icon">
                <i class="layui-icon layui-icon-email"></i>
            </div>
            <h3>å‘é€æˆåŠŸ</h3>
            <p>è®¢é˜…åœ°å€å·²å‘é€åˆ°æ‚¨çš„QQé‚®ç®±ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ã€‚</p>
            <button class="modal-btn unified-btn" onclick="closeModal('emailSuccessModal')">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
    <div id="resetConfirmModal" class="custom-modal">
        <div class="modal-content unified-modal">
            <div class="icon-wrapper unified-icon warning">
                <i class="layui-icon layui-icon-help"></i>
            </div>
            <h3>ç¡®è®¤é‡ç½®è®¢é˜…åœ°å€ï¼Ÿ</h3>
            <p>æ­¤æ“ä½œä¸å¯é€†ï¼Œæ—§çš„è®¢é˜…é“¾æ¥å°†ç«‹å³å¤±æ•ˆã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="modal-btn unified-btn secondary" onclick="closeModal('resetConfirmModal')">å–æ¶ˆ</button>
                <button class="modal-btn unified-btn danger" onclick="confirmReset()">ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>
    <div id="resetSuccessModal" class="custom-modal">
        <div class="modal-content unified-modal">
            <div class="icon-wrapper unified-icon">
                <i class="layui-icon layui-icon-ok"></i>
            </div>
            <h3>é‡ç½®æˆåŠŸ</h3>
            <p>æ‚¨çš„è®¢é˜…åœ°å€å·²æ›´æ–°ï¼Œæ—§é“¾æ¥å·²å¤±æ•ˆã€‚</p>
            <button class="modal-btn unified-btn" onclick="closeModalAndReload('resetSuccessModal')">å¥½çš„ï¼Œåˆ·æ–°é¡µé¢</button>
        </div>
    </div>

    <!-- è®¾å¤‡æ•°é‡è¶…é™æé†’å¼¹çª— -->
    <div id="deviceLimitModal" class="custom-modal">
        <div class="modal-content unified-modal">
            <div class="icon-wrapper unified-icon warning">
                <i class="layui-icon layui-icon-alert"></i>
            </div>
            <h3>è®¾å¤‡æ•°é‡è¶…é™æé†’</h3>
            <p style="text-align: left; line-height: 1.6;">
                <strong>å½“å‰çŠ¶æ€ï¼š</strong>æ‚¨çš„åœ¨çº¿è®¾å¤‡æ•°é‡å·²è¾¾åˆ°æœ€å¤§é™åˆ¶ï¼ˆ{$data['drivers']}/{$data['setdrivers']}ï¼‰ã€‚<br><br>
                <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                1. ç‚¹å‡»ä¸‹æ–¹"é‡ç½®è®¢é˜…åœ°å€"æŒ‰é’®<br>
                2. ä½¿ç”¨æ–°çš„è®¢é˜…åœ°å€é‡æ–°é…ç½®æ‚¨çš„è®¾å¤‡<br>
                3. è¿™æ ·å¯ä»¥æ¸…é™¤æ‰€æœ‰åœ¨çº¿è®¾å¤‡è®°å½•ï¼Œé‡æ–°å¼€å§‹è®¡æ•°<br><br>
                <strong>æ³¨æ„ï¼š</strong>é‡ç½®åéœ€è¦é‡æ–°é…ç½®æ‰€æœ‰è®¾å¤‡ï¼Œä½†ä¸ä¼šå½±å“æ‚¨çš„æœåŠ¡æ—¶é•¿ã€‚
            </p>
            <div class="modal-buttons">
                <button class="modal-btn unified-btn secondary" onclick="closeModal('deviceLimitModal')">ç¨åå¤„ç†</button>
                <button class="modal-btn unified-btn danger" onclick="handleDeviceLimit()">ç«‹å³é‡ç½®</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="page-header">
            <h1>è®¢é˜…ç®¡ç†</h1>
        </div>

        <div class="card stats-card">
            <div class="stats-content">
                <h3>å‰©ä½™æ—¶é•¿</h3>
                <div class="stats-number">{$data['endtime']} å¤©</div>
                <div class="expiry-date">
                    åˆ°æœŸæ—¶é—´ï¼š<span id="expiryDate"></span>
                </div>
                <div class="expiry-warning" id="expiryWarning"></div>
                <div class="stats-number" style="font-size:1.2rem;margin-top:1rem;">
                    å½“å‰è®¾å¤‡æ•°ï¼š<span id="currentDevices" style="color:#ffd700;">{$data['drivers']}</span> / <span style="color:var(--color-primary);">{$data['setdrivers']}</span> ä¸ª
                    <span style="font-size:0.95rem;color:#888;margin-left:8px;">ï¼ˆå½“å‰/æœ€å¤§ï¼‰</span>
                </div>
                <div id="deviceWarning" style="margin-top:0.5rem;font-size:0.9rem;color:#ff6b6b;display:none;">
                    <i class="layui-icon layui-icon-alert"></i> è®¾å¤‡æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå»ºè®®é‡ç½®è®¢é˜…åœ°å€
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="iconfont icon-notification"></i>&nbsp;ç½‘ç«™å…¬å‘Š</div>
            <div class="card-body">
                <strong>è¯·éµå®ˆèŠ‚ç‚¹å½“åœ°å’Œæ‚¨æ‰€åœ¨å›½å®¶çš„æ³•å¾‹æ³•è§„ï¼Œç¦æ­¢ç”¨ä½œè¿è§„è¡Œä¸ºï¼Œä¸è¦å‘è¡¨ä¸è¯¥è¯´çš„è¨€è®ºï¼Œä¸è¦è®¤ä¸ºæ¢äº†IPå°±æ‰¾ä¸åˆ°ä½ ï¼Œå‡ºé—®é¢˜åæœè‡ªè´Ÿï¼Œè¯·è°¨è¨€æ…è¡Œæ‰æ˜¯ç”Ÿå­˜ä¹‹é“ï¼</strong>
                <br><br>
                <div id="deviceManagementTip" style="padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; margin-bottom: 15px; display: none;">
                    <strong style="color: #856404;">ğŸ“± è®¾å¤‡ç®¡ç†æç¤ºï¼š</strong>
                    <p style="margin: 8px 0 0 0; color: #856404; font-size: 14px;">
                        å½“æ‚¨çš„è®¾å¤‡æ•°é‡è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå¯ä»¥ç‚¹å‡»ä¸‹æ–¹"ä¸€é”®é‡ç½®è®¢é˜…åœ°å€"æŒ‰é’®æ¥æ¸…é™¤æ‰€æœ‰åœ¨çº¿è®¾å¤‡è®°å½•ï¼Œç„¶åä½¿ç”¨æ–°çš„è®¢é˜…åœ°å€é‡æ–°é…ç½®æ‚¨çš„è®¾å¤‡ã€‚
                    </p>
                </div>
                <a class="btn btn-primary" href="javascript:void(0);" onclick="showModal('resetConfirmModal')">ä¸€é”®é‡ç½®è®¢é˜…åœ°å€</a>
                <a class="btn btn-primary" onclick="sendSubscriptionEmail()">
                    <i class="layui-icon layui-icon-email"></i> å‘é€è®¢é˜…åœ°å€åˆ°è‡ªå·±qqé‚®ç®±
                </a>
                <div>è¯·æ³¨æ„ï¼Œç‚¹å‡»é‡ç½®è®¢é˜…ä¹‹åï¼Œä½ ä¹‹å‰æ‰€æœ‰çš„é“¾æ¥éƒ½ä¼šå¤±æ•ˆã€‚</div>
                <br>
                <strong style="color:red">ç»­è´¹è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®</strong>
                <hr>
                <a class="btn btn-primary"  href="/tc" target="_blank">ç»­è´¹è¯·ç‚¹å‡»æˆ‘</a>
            </div>
        </div>

                </form>
                <div class="input-group">
                    <input type="text" class="form-control" readonly value="{$data['mobileshorturl']}">
                    <button type="button" class="btn btn-primary sub-ssr" data-clipboard-text="{$data['mobileshorturl']}">å¤åˆ¶</button>
                </div>
                <div style="margin-bottom: 1rem; padding: 8px 12px; background: #e3f2fd; border-radius: 6px; color: var(--color-primary-active); font-size: 0.95rem; font-weight: 500;">
                    <i class="layui-icon layui-icon-tips"></i>
                    é€‚é…è½¯ä»¶ï¼šShadowrocketã€V2Rayã€Hiddify
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" readonly value="{$data['clashshorturl']}">
                    <button type="button" class="btn btn-primary sub-ssr" data-clipboard-text="{$data['clashshorturl']}">å¤åˆ¶</button>
                </div>
                <div style="margin-bottom: 1rem; padding: 8px 12px; background: #e8f5e9; border-radius: 6px; color: #2e7d32; font-size: 0.95rem; font-weight: 500;">
                    <i class="layui-icon layui-icon-tips"></i>
                    é€‚é…è½¯ä»¶ï¼šç”µè„‘ç‰ˆClashã€å®‰å“ç‰ˆClash Metaã€ç”µè„‘ç‰ˆMihomo Part
                </div>
                <a class="btn btn-primary" href="clash://install-config?url={$data['clashshorturl']}&name={$data['jsdate']}_åˆ°æœŸ">å°çŒ«å’ªè½¯ä»¶ä¸€é”®å¯¼å…¥</a>
                <div>æ­¤æ­¥éª¤çœç•¥å¤åˆ¶è®¢é˜…åœ°å€åˆ°å°çŒ«å’ªè½¯ä»¶ä¸‹è½½é…ç½®çš„æ­¥éª¤ï¼Œæ–¹ä¾¿å¿«æ·</div>
                <div id="qrcode"></div>
                <a class="btn btn-primary" onclick="ssr_AddSub('{$data[\'mobileshorturl\']}','shadowrocket://add/sub://','{$data[\'jsdate\']}')">å°ç«ç®­ä¸€é”®å¯¼å…¥</a>
                <div class="card">
                  <div class="card-header"><i class="iconfont icon-cloud-download"></i>&nbsp;å¿«é€Ÿé…ç½®</div>
                  <div class="card-body">
                      <form class="layui-form" lay-filter="course_ssr">
                          <select name="interest" lay-filter="filter_ssr">
                              <option value="windows">Windows</option>
                              <option value="android">Android</option>
                              <option value="mac">Mac</option>
                              <option value="ios">iOS</option>
                          </select>
                <!-- å®¢æˆ·ç«¯ä¸‹è½½åŒºåŸŸ -->
                <div class="client-downloads" id="clientDownloads">
                    <!-- Windowså®¢æˆ·ç«¯ -->
                    <div id="windows-client" class="client-card">
                        <div class="download-item">
                            <span>Windowså®¢æˆ·ç«¯</span>
                            <a id="dl-win" href="#" class="download-btn">
                                <i class="layui-icon layui-icon-download-circle"></i>
                                ä¸‹è½½
                            </a>
                        </div>
                    </div>

                    <!-- Androidå®¢æˆ·ç«¯ -->
                    <div id="android-client" class="client-card">
                        <div class="download-item">
                            <span>å®‰å“çŒ«å’ªè½¯ä»¶</span>
                            <a id="dl-android" href="#" class="download-btn">
                                <i class="layui-icon layui-icon-download-circle"></i>
                                ä¸‹è½½
                            </a>
                        </div>
                        <div class="download-item">
                            <span>å®‰å“Hiddifyè½¯ä»¶</span>
                            <a href="https://ghfast.top/https://github.com/hiddify/hiddify-app/releases/download/v2.5.7/Hiddify-Android-arm64.apk" class="download-btn">
                                <i class="layui-icon layui-icon-download-circle"></i>
                                ä¸‹è½½
                            </a>
                        </div>
                    </div>

                    <!-- Macå®¢æˆ·ç«¯ -->
                    <div id="mac-client" class="client-card">
                        <div class="download-item">
                            <span>Mac IntelèŠ¯ç‰‡</span>
                            <a id="dl-mac-intel" href="#" class="download-btn">
                                <i class="layui-icon layui-icon-download-circle"></i>
                                ä¸‹è½½
                            </a>
                        </div>
                        <div class="download-item">
                            <span>Mac è‹¹æœèŠ¯ç‰‡</span>
                            <a id="dl-mac-arm" href="#" class="download-btn">
                                <i class="layui-icon layui-icon-download-circle"></i>
                                ä¸‹è½½
                            </a>
                        </div>
                    </div>

                    <!-- iOSå®¢æˆ·ç«¯ -->
                    <div id="ios-client" class="client-card">
                        <div class="download-item">
                            <span>Shadowrocket</span>
                            <span class="notice">App Storeè‡ªè¡Œä¸‹è½½</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡ç®¡ç†åŒºåŸŸ -->
        <div class="card">
            <div class="card-header">
                <i class="iconfont icon-mobile"></i>&nbsp;è®¾å¤‡ç®¡ç†
                <span class="device-count-badge" id="deviceCountBadge">åŠ è½½ä¸­...</span>
            </div>
            <div class="card-body">
                <div class="device-management-intro">
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
                        <i class="layui-icon layui-icon-tips"></i>
                        æ‚¨å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†å½“å‰åœ¨çº¿çš„è®¾å¤‡ï¼Œåˆ é™¤ä¸éœ€è¦çš„è®¾å¤‡ä»¥é‡Šæ”¾è®¾å¤‡æ•°é‡é™åˆ¶ã€‚
                    </p>
                </div>

                <div class="device-actions">
                    <button class="btn btn-primary" onclick="refreshDeviceList()" id="refreshDeviceBtn">
                        <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                    </button>
                </div>

                <div class="device-list-container" id="deviceListContainer">
                    <div class="device-loading" id="deviceLoading" style="text-align: center; padding: 40px; color: #999;">
                        <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
                        <p>æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</p>
                    </div>
                    <div class="device-list" id="deviceList" style="display: none;">
                        <!-- è®¾å¤‡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="device-empty" id="deviceEmpty" style="display: none; text-align: center; padding: 40px; color: #999;">
                        <i class="layui-icon layui-icon-face-surprised" style="font-size: 48px; color: #ddd;"></i>
                        <p>æš‚æ— åœ¨çº¿è®¾å¤‡</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="copy-tooltip" id="copyTooltip">å¤åˆ¶æˆåŠŸ!</div>
</block>

<block name="footer">
    <script src="/Public/statics/user/breakpoints.min.js"></script>
    <script src="/Public/statics/user/script.min.js"></script>
    <script src="/Public/statics/user/clipboard.min.js"></script>
    <script src="/Public/statics/user/main.js"></script>
    <script src="/Public/statics/user/layui.js"></script>
    <script src="/Public/statics/user/dropdown.js"></script>
    <script src="/Public/statics/user/wangEditor.min.js"></script>
    <script src="/Public/statics/user/jquery.qrcode.min.js"></script>
    <script src="/Public/statics/user/jquery.slimscroll.js"></script>
    <script src="/Public/statics/user/perfect-scrollbar.jquery.js"></script>
    <script src="/Public/statics/user/library.js"></script>
    <script src="/Public/statics/user/plugins.js"></script>
    <script src="/Public/statics/user/app.min.js"></script>
    <script src="/Public/statics/user/jquery-validation.js"></script>
    <script>
        layui.use('layer', function(){
            var layer = layui.layer;
            var os = layui.device();
            if(os.os == 'windows'){ document.getElementById("devices").innerText="windows"; }
            if(os.android == true){ document.getElementById("devices").innerText="android"; }
            if(os.os == 'mac'){ document.getElementById("devices").innerText="mac"; }
            if(os.os == 'ios'){ document.getElementById("devices").innerText="ios"; }
            if(os.os == 'linux' && os.android == false){ document.getElementById("devices").innerText="linux"; }
        });
        layui.use('form',function(){});
    </script>
    <script>
        layui.use(['form', 'element'], function(){
            var form = layui.form;

            // 1. å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›´æ–°æ˜¾ç¤ºçš„å¡ç‰‡
            function updateClientCard(selectedValue) {
                // éšè—æ‰€æœ‰ä¸‹è½½å¡ç‰‡
                document.querySelectorAll('.client-card').forEach(card => {
                    card.classList.remove('active');
                });

                // æ˜¾ç¤ºé€‰ä¸­çš„å®¢æˆ·ç«¯ä¸‹è½½å¡ç‰‡
                const clientCard = document.querySelector(`#${selectedValue}-client`);
                if(clientCard) {
                    clientCard.classList.add('active');
                }
            }

            // 2. ä¸ºä¸‹æ‹‰æ¡†é€‰æ‹©äº‹ä»¶ç»‘å®šè¿™ä¸ªå‡½æ•°
            form.on('select(filter_ssr)', function(data){
                updateClientCard(data.value);
            });

            // 3. é¡µé¢åŠ è½½å®Œæˆåï¼Œé»˜è®¤æ˜¾ç¤ºWindowsçš„å¡ç‰‡
            updateClientCard('windows');
        });
    </script>
    <script>
        $(function(){ new Clipboard('.sub-ssr'); });
        $(".sub-ssr").click(function (){ showCopyTooltip(); });
        $(function(){ new Clipboard('.sub-quantumult'); });
        $(".sub-ssr-quantumult").click(function (){ showCopyTooltip(); });
    </script>
    <script>
        function ssr_AddSub(url,jumpurl="",$endDate='') {
            let tmp = window.btoa(url);
            if($endDate){
                window.location.href = jumpurl + tmp + '?remarks='+ $endDate;
            }else{
                window.location.href = jumpurl + tmp;
            }
        }
        var el = kjua({text:'{$data[\'qrcodeUrl\']}',render:'image',size:224})
        document.querySelector('#qrcode').appendChild(el);

        function Copyconfig(url,id,jumpurl="") {
            $.ajax({
                url: url,
                type: 'get',
                async: false,
                success: function(res) {
                    if(res) {
                        layer.open({ content: 'è·å–æˆåŠŸ' });
                        $(id).data('data', res);
                        console.log(res);
                    } else {
                        layer.open({ content: 'è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•' });
                    }
                }
            });
            const clipboard = new Clipboard('.copy-config', {
                text: function() {
                    return $(id).data('data');
                }
            });
            clipboard.on('success', function(e) {
                if (jumpurl != "") {
                    layer.open({ content: 'å¤åˆ¶æˆåŠŸï¼Œå³å°†è·³è½¬åˆ° APP' });
                    window.setTimeout(function () {
                        window.location.href = jumpurl;
                    }, 1000);
                } else {
                    layer.open({ content: 'å¤åˆ¶æˆåŠŸ' });
                }
            });
            clipboard.on("error",function(e){
                console.error('Action:', e.action);
                console.error('Trigger:', e.trigger);
                console.error('Text:', e.text);
            });
        }

        // å¤åˆ¶æˆåŠŸæç¤º
        function showCopyTooltip() {
            const tooltip = document.getElementById('copyTooltip');
            tooltip.classList.add('show');
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 2000);
        }

        // ç®€åŒ–åˆ°æœŸæ—¥æœŸè®¡ç®—
        function calculateExpiryDate() {
            const remainingDays = parseInt("{$data['endtime']}");
            const today = new Date();
            const expiryDate = new Date(today.setDate(today.getDate() + remainingDays));

            const year = expiryDate.getFullYear();
            const month = expiryDate.getMonth() + 1;
            const day = expiryDate.getDate();

            document.getElementById('expiryDate').innerHTML =
                `${year}å¹´${month}æœˆ${day}æ—¥`;

            const warningEl = document.getElementById('expiryWarning');
            if (remainingDays <= 7) {
                warningEl.innerHTML = "âš ï¸ æ‚¨çš„æœåŠ¡å³å°†åˆ°æœŸï¼Œè¯·åŠæ—¶ç»­è´¹ï¼";
                warningEl.style.color = "#ff4444";
            } else if (remainingDays <= 30) {
                warningEl.innerHTML = "æé†’ï¼šå»ºè®®æå‰ç»­è´¹ä»¥ç¡®ä¿æœåŠ¡ä¸ä¸­æ–­";
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.addEventListener('load', function() {
            calculateExpiryDate();
            checkDeviceLimit();
        });

        // æ£€æŸ¥è®¾å¤‡æ•°é‡æ˜¯å¦è¶…é™
        function checkDeviceLimit() {
            const currentDevices = parseInt("{$data['drivers']}");
            const maxDevices = parseInt("{$data['setdrivers']}");
            const currentDevicesEl = document.getElementById('currentDevices');
            const deviceWarningEl = document.getElementById('deviceWarning');
            const deviceManagementTipEl = document.getElementById('deviceManagementTip');

            // æ›´æ–°è®¾å¤‡æ•°é‡æ˜¾ç¤ºé¢œè‰²
            if (currentDevices >= maxDevices) {
                currentDevicesEl.style.color = '#ff6b6b'; // çº¢è‰²è­¦å‘Š
                deviceWarningEl.style.display = 'block';
                deviceManagementTipEl.style.display = 'block';

                // å»¶è¿Ÿæ˜¾ç¤ºå¼¹çª—ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(function() {
                    showModal('deviceLimitModal');
                }, 1000);
            } else if (currentDevices >= maxDevices * 0.8) {
                // å½“è®¾å¤‡æ•°é‡è¾¾åˆ°80%æ—¶æ˜¾ç¤ºé»„è‰²è­¦å‘Š
                currentDevicesEl.style.color = '#ffa726'; // æ©™è‰²è­¦å‘Š
                deviceWarningEl.style.display = 'block';
                deviceWarningEl.innerHTML = '<i class="layui-icon layui-icon-alert"></i> è®¾å¤‡æ•°é‡æ¥è¿‘ä¸Šé™ï¼Œè¯·æ³¨æ„ç®¡ç†';
                deviceWarningEl.style.color = '#ffa726';
                deviceManagementTipEl.style.display = 'block';
            }
        }

        // å¤„ç†è®¾å¤‡æ•°é‡è¶…é™
        function handleDeviceLimit() {
            closeModal('deviceLimitModal');
            showModal('resetConfirmModal');
        }

        // é€šç”¨å¼¹çª—æ§åˆ¶
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        function closeModalAndReload(modalId) {
            closeModal(modalId);
            window.location.reload();
        }

        // é‚®ä»¶å‘é€é€»è¾‘
        function sendSubscriptionEmail() {
            var loadingIndex = layer.load(1);
            $.ajax({
                url: '/send',
                type: 'POST',
                data: {
                    qq: '{$data["qq"]}',
                    mobileUrl: '{$data["ms"]}',
                    clashUrl: '{$data["cs"]}'
                },
                dataType: 'json',
                success: function(res) {
                    layer.close(loadingIndex);
                    if (res.code === 0) {
                        showModal('emailSuccessModal');
                    } else {
                        layer.alert(res.msg || 'å‘é€å¤±è´¥', {icon: 2});
                    }
                },
                error: function() {
                    layer.close(loadingIndex);
                    layer.alert('ç½‘ç»œè¯·æ±‚å¤±è´¥', {icon: 2});
                }
            });
        }

        // é‡ç½®è®¢é˜…åœ°å€é€»è¾‘
        function confirmReset() {
            closeModal('resetConfirmModal');
            var loadingIndex = layer.load(1);
            $.ajax({
                url: '/reseturl',
                type: 'POST',
                dataType: 'json',
                success: function(res) {
                    layer.close(loadingIndex);
                    if (res.status === 1) {
                        window.location.reload(); // ç›´æ¥åˆ·æ–°é¡µé¢
                    } else {
                        // å¤±è´¥æ—¶å¯é€‰æç¤º
                        layer.alert(res.msg || 'é‡ç½®å¤±è´¥', {icon: 2});
                    }
                },
                error: function() {
                    layer.close(loadingIndex);
                    window.location.reload(); // ç½‘ç»œå¼‚å¸¸ä¹Ÿå¼ºåˆ¶åˆ·æ–°é¡µé¢
                }
            });
        }
    </script>
    <script>
         // è®¾å¤‡ç®¡ç†åŠŸèƒ½
         let currentDeviceData = null;
         let isDeviceListLoading = false;

         // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½è®¾å¤‡åˆ—è¡¨
         window.addEventListener('load', function() {
             setTimeout(function() {
                 loadDeviceList();
             }, 500);
         });

         // åˆ·æ–°è®¾å¤‡åˆ—è¡¨å‡½æ•°
         function refreshDeviceList() {
             if (isDeviceListLoading) {
                 layer.msg('æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...', {icon: 16});
                 return;
             }

             console.log('æ‰‹åŠ¨åˆ·æ–°è®¾å¤‡åˆ—è¡¨');
             loadDeviceList();
         }


         // åŠ è½½è®¾å¤‡åˆ—è¡¨
         function loadDeviceList() {
             // é˜²æ­¢é‡å¤åŠ è½½
             if (isDeviceListLoading) {
                 console.log('è®¾å¤‡åˆ—è¡¨æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                 return;
             }

             isDeviceListLoading = true;

             const loadingEl = document.getElementById('deviceLoading');
             const deviceListEl = document.getElementById('deviceList');
             const deviceEmptyEl = document.getElementById('deviceEmpty');
             const deviceCountBadgeEl = document.getElementById('deviceCountBadge');
             const refreshBtn = document.getElementById('refreshDeviceBtn');

             // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
             loadingEl.style.display = 'block';
             deviceListEl.style.display = 'none';
             deviceEmptyEl.style.display = 'none';
             deviceCountBadgeEl.textContent = 'åŠ è½½ä¸­...';

             // ç¦ç”¨åˆ·æ–°æŒ‰é’®
             if (refreshBtn) {
                 refreshBtn.disabled = true;
                 refreshBtn.innerHTML = '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> åŠ è½½ä¸­...';
             }

             // è·å–ç”¨æˆ·æ•°æ®
             const dingyueId = parseInt("{$data['id']}") || 0;
             const qq = "{$data['qq']}" || '';

             // è°ƒè¯•ä¿¡æ¯
             console.log('è°ƒè¯•ä¿¡æ¯ - dingyueId:', dingyueId, 'ç±»å‹:', typeof dingyueId);
             console.log('è°ƒè¯•ä¿¡æ¯ - qq:', qq, 'ç±»å‹:', typeof qq);

             // éªŒè¯å‚æ•°
             if (!dingyueId || dingyueId <= 0) {
                 console.error('dingyueIdæ— æ•ˆ:', dingyueId);
                 loadingEl.style.display = 'none';
                 deviceCountBadgeEl.textContent = 'å‚æ•°é”™è¯¯';
                 layer.alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼šè®¢é˜…IDæ— æ•ˆ', {icon: 2});
                 return;
             }

             if (!qq || !/^\d+$/.test(qq)) {
                 console.error('qqæ— æ•ˆ:', qq);
                 loadingEl.style.display = 'none';
                 deviceCountBadgeEl.textContent = 'å‚æ•°é”™è¯¯';
                 layer.alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼šQQå·æ— æ•ˆ', {icon: 2});
                 return;
             }

             $.ajax({
                 url: '/getDeviceList',
                 type: 'POST',
                 data: {
                     dingyue_id: dingyueId,
                     qq: qq
                 },
                 dataType: 'json',
                 timeout: 10000,
                 success: function(res) {
                     // é‡ç½®åŠ è½½çŠ¶æ€
                     isDeviceListLoading = false;
                     loadingEl.style.display = 'none';

                     // æ¢å¤åˆ·æ–°æŒ‰é’®
                     if (refreshBtn) {
                         refreshBtn.disabled = false;
                         refreshBtn.innerHTML = '<i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°è®¾å¤‡åˆ—è¡¨';
                     }

                     // è°ƒè¯•ä¿¡æ¯
                     console.log('è®¾å¤‡åˆ—è¡¨å“åº”:', res);

                     if (res && res.code === 0) {
                         currentDeviceData = res.data || [];

                         // æ›´æ–°è®¾å¤‡æ•°é‡å¾½ç« 
                         const currentDevices = res.current_devices || 0;
                         const maxDevices = res.max_devices || 0;
                         deviceCountBadgeEl.textContent = `${currentDevices}/${maxDevices}`;

                         if (res.data && res.data.length > 0) {
                             renderDeviceList(res.data);
                             deviceListEl.style.display = 'block';
                         } else {
                             deviceEmptyEl.style.display = 'block';
                         }

                         // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä»…åœ¨æ‰‹åŠ¨åˆ·æ–°æ—¶ï¼‰
                         if (refreshBtn && refreshBtn.disabled === false) {
                             layer.msg('è®¾å¤‡åˆ—è¡¨åˆ·æ–°æˆåŠŸ', {icon: 1, time: 1500});
                         }
                     } else {
                         const errorMsg = (res && res.msg) ? res.msg : 'è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥';
                         console.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥:', errorMsg);
                         layer.alert(errorMsg, {icon: 2});
                         deviceCountBadgeEl.textContent = 'åŠ è½½å¤±è´¥';
                     }
                 },
                 error: function(xhr, status, error) {
                     // é‡ç½®åŠ è½½çŠ¶æ€
                     isDeviceListLoading = false;
                     loadingEl.style.display = 'none';

                     // æ¢å¤åˆ·æ–°æŒ‰é’®
                     if (refreshBtn) {
                         refreshBtn.disabled = false;
                         refreshBtn.innerHTML = '<i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°è®¾å¤‡åˆ—è¡¨';
                     }

                     console.error('è®¾å¤‡åˆ—è¡¨è¯·æ±‚å¤±è´¥:', {
                         status: status,
                         error: error,
                         responseText: xhr.responseText,
                         statusCode: xhr.status
                     });

                     let errorMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
                     if (status === 'timeout') {
                         errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
                     } else if (xhr.status === 404) {
                         errorMsg = 'æ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è·¯ç”±é…ç½®';
                     } else if (xhr.status === 500) {
                         errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                     }

                     layer.alert(errorMsg, {icon: 2});
                     deviceCountBadgeEl.textContent = 'ç½‘ç»œé”™è¯¯';
                 }
             });
         }

         // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
         function renderDeviceList(devices) {
             const deviceListEl = document.getElementById('deviceList');
             let html = '';

             devices.forEach(function(device) {
                 const normalizedUA = device.normalized_ua || 'æœªçŸ¥è®¾å¤‡';
                 const lastSeen = formatLastSeen(device.last_seen);
                 const deviceLogo = getDeviceLogo(normalizedUA);

                 html += `
                     <div class="device-item" data-fingerprint="${device.fingerprint}">
                         <div class="device-info">
                             <div class="device-logo ${deviceLogo}">
                                 <i class="${getSoftwareIcon(normalizedUA)}"></i>
                             </div>
                             <div class="device-details">
                                 <div class="device-name">${normalizedUA}</div>
                                 <div class="device-last-seen">æœ€åè®¿é—®: ${lastSeen}</div>
                             </div>
                         </div>
                         <div class="device-actions-btns">
                             <button class="device-remove-btn" onclick="removeDevice('${device.fingerprint}')">
                                 <i class="layui-icon layui-icon-delete"></i>
                                 åˆ é™¤
                             </button>
                         </div>
                     </div>
                 `;
             });

             deviceListEl.innerHTML = html;
         }

         // è·å–è®¾å¤‡logoæ ·å¼ç±»
         function getDeviceLogo(normalizedUA) {
             if (!normalizedUA) return 'default';

             const name = normalizedUA.toLowerCase();

             // ä¼˜å…ˆæ£€æŸ¥è½¯ä»¶åç§°ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
             if (name.includes('flclash')) return 'flclash';
             if (name.includes('shadowrocket')) return 'shadowrocket';
             if (name.includes('clash')) return 'clash';
             if (name.includes('v2ray')) return 'v2ray';
             if (name.includes('quantumult')) return 'quantumult';
             if (name.includes('surge')) return 'surge';
             if (name.includes('loon')) return 'loon';
             if (name.includes('stash')) return 'stash';
             if (name.includes('sparkle')) return 'sparkle';

             // å¦‚æœæ ‡å‡†åŒ–UAåŒ…å«iPhone/iPadç­‰è‹¹æœè®¾å¤‡ï¼Œé»˜è®¤ä¸ºshadowrocket
             if (name.includes('iphone') || name.includes('ipad') || name.includes('ipod')) {
                 return 'shadowrocket';
             }

             return 'default';
         }

         // è·å–è½¯ä»¶å›¾æ ‡
         function getSoftwareIcon(normalizedUA) {
             if (!normalizedUA) return 'fas fa-mobile-alt';

             const name = normalizedUA.toLowerCase();

             // æ ¹æ®è½¯ä»¶ç±»å‹è¿”å›å¯¹åº”å›¾æ ‡ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
             if (name.includes('flclash')) {
                 return 'fas fa-desktop';
             }
             if (name.includes('shadowrocket')) {
                 return 'fas fa-rocket';
             }
             if (name.includes('clash')) {
                 return 'fas fa-cat';
             }
             if (name.includes('v2ray')) {
                 return 'fas fa-shield-alt';
             }
             if (name.includes('quantumult')) {
                 return 'fas fa-atom';
             }
             if (name.includes('surge')) {
                 return 'fas fa-bolt';
             }
             if (name.includes('loon')) {
                 return 'fas fa-feather-alt';
             }
             if (name.includes('stash')) {
                 return 'fas fa-box';
             }
             if (name.includes('sparkle')) {
                 return 'fas fa-sparkles';
             }

             // è®¾å¤‡ç±»å‹å›¾æ ‡
             if (name.includes('iphone')) {
                 return 'fab fa-apple';
             }
             if (name.includes('ipad')) {
                 return 'fas fa-tablet-alt';
             }
             if (name.includes('android')) {
                 return 'fab fa-android';
             }
             if (name.includes('windows')) {
                 return 'fab fa-windows';
             }
             if (name.includes('mac')) {
                 return 'fab fa-apple';
             }
             if (name.includes('linux')) {
                 return 'fab fa-linux';
             }

             return 'fas fa-mobile-alt';
         }


         // æ ¼å¼åŒ–æœ€åè®¿é—®æ—¶é—´
         function formatLastSeen(lastSeen) {
             if (!lastSeen) return 'æœªçŸ¥';

             // æ£€æŸ¥æ˜¯å¦ä¸ºUnixæ—¶é—´æˆ³ï¼ˆçº¯æ•°å­—ï¼‰
             if (/^\d+$/.test(lastSeen)) {
                 const timestamp = parseInt(lastSeen);
                 const date = new Date(timestamp * 1000);

                 const year = date.getFullYear();
                 const month = String(date.getMonth() + 1).padStart(2, '0');
                 const day = String(date.getDate()).padStart(2, '0');
                 const hours = String(date.getHours()).padStart(2, '0');
                 const minutes = String(date.getMinutes()).padStart(2, '0');
                 const seconds = String(date.getSeconds()).padStart(2, '0');

                 return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
             }

             // å¦‚æœä¸æ˜¯æ—¶é—´æˆ³ï¼Œç›´æ¥è¿”å›åŸå§‹å€¼
             return lastSeen;
         }

         // åˆ é™¤è®¾å¤‡
         function removeDevice(fingerprint) {
             const dingyueId = "{$data['id']}";
             const qq = "{$data['qq']}";

             // è°ƒè¯•ä¿¡æ¯
             console.log('åˆ é™¤è®¾å¤‡è°ƒè¯• - fingerprint:', fingerprint);
             console.log('åˆ é™¤è®¾å¤‡è°ƒè¯• - dingyueId:', dingyueId);
             console.log('åˆ é™¤è®¾å¤‡è°ƒè¯• - qq:', qq);

             $.ajax({
                 url: '/removeDevice',
                 type: 'POST',
                 data: {
                     fingerprint: fingerprint,
                     dingyue_id: dingyueId,
                     qq: qq
                 },
                 dataType: 'json',
                 success: function(res) {
                     // è°ƒè¯•ä¿¡æ¯
                     console.log('åˆ é™¤è®¾å¤‡å“åº”:', res);

                     if (res.code === 0) {
                         layer.msg('è®¾å¤‡åˆ é™¤æˆåŠŸ', {icon: 1});
                         // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                         loadDeviceList();
                         // æ›´æ–°é¡µé¢ä¸Šçš„è®¾å¤‡æ•°é‡æ˜¾ç¤º
                         updateDeviceCount();
                     } else {
                         layer.alert(res.msg || 'åˆ é™¤å¤±è´¥', {icon: 2});
                     }
                 },
                 error: function(xhr, status, error) {
                     console.error('åˆ é™¤è®¾å¤‡è¯·æ±‚å¤±è´¥:', {
                         status: status,
                         error: error,
                         responseText: xhr.responseText,
                         statusCode: xhr.status
                     });
                     layer.alert('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error, {icon: 2});
                 }
             });
         }

         // æ›´æ–°è®¾å¤‡æ•°é‡æ˜¾ç¤º
         function updateDeviceCount() {
             // é‡æ–°è·å–è®¾å¤‡æ•°é‡å¹¶æ›´æ–°é¡µé¢æ˜¾ç¤º
             setTimeout(function() {
                 loadDeviceList();
             }, 1000);
         }
     </script>
     <script>
    // GitHubåŠ é€ŸæœåŠ¡é…ç½®ï¼ˆæŒ‰ç¨³å®šæ€§æ’åºï¼‰
    const githubMirrors = [
        'https://ghfast.top',
        'https://ghproxy.com',
        'https://github.91chi.fun'
    ];

    // æ™ºèƒ½ä¸‹è½½é“¾æ¥è®¾ç½®ï¼Œä½¿ç”¨æœ€ç¨³å®šçš„åŠ é€ŸæœåŠ¡
    async function setDownloadLink(repo, assetMatch, btnId) {
        try {
            const response = await fetch(`https://api.github.com/repos/${repo}/releases/latest`);
            const data = await response.json();
            const asset = data.assets.find(a => a.name.match(assetMatch));

            if (asset) {
                const btn = document.getElementById(btnId);
                // ä½¿ç”¨URLç¼–ç æ–¹å¼æ„å»ºåŠ é€Ÿé“¾æ¥
                const acceleratedUrl = githubMirrors[0] + '/?q=' + encodeURIComponent(asset.browser_download_url);
                btn.href = acceleratedUrl;
                btn.innerText = 'ä¸‹è½½æœ€æ–°ç‰ˆ';
                console.log(`è®¾ç½®ä¸‹è½½é“¾æ¥: ${acceleratedUrl}`);
            } else {
                document.getElementById(btnId).innerText = 'æœªæ‰¾åˆ°å®‰è£…åŒ…';
            }
        } catch (error) {
            document.getElementById(btnId).innerText = 'è·å–å¤±è´¥';
            console.error('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥:', error);
        }
    }

    setDownloadLink('xishang0128/sparkle', /windows.*x64.*setup.*\.exe$/i, 'dl-win');
    setDownloadLink('xishang0128/sparkle', /macos.*x64.*(pkg|dmg)$/i, 'dl-mac-intel');
    setDownloadLink('xishang0128/sparkle', /macos.*arm64.*(pkg|dmg)$/i, 'dl-mac-arm');
    setDownloadLink('MetaCubeX/ClashMetaForAndroid', /arm64.*release.*\.apk$/i, 'dl-android');
</script>
</block>
